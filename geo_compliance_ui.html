<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi-2 v5 Geo-Compliance Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8d6 50%, #ffdab9 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #2c3e50;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            border: none;
        }

        .header {
            background: linear-gradient(135deg, #d2691e 0%, #cd853f 50%, #daa520 100%);
            color: #fff;
            padding: 30px;
            text-align: center;
            border-bottom: 3px solid #8b4513;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 600;
            font-family: 'Georgia', serif;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            font-style: italic;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 80vh;
        }

        .input-section {
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-right: 2px solid #e8d5c4;
        }

        .output-section {
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
            font-family: 'Georgia', serif;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e8d5c4;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            font-family: 'Georgia', serif;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #d2691e;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 10px rgba(210, 105, 30, 0.2);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #7f8c8d;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .analyze-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #d2691e, #cd853f);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(210, 105, 30, 0.3);
            font-family: 'Georgia', serif;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(210, 105, 30, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #a0a0a0;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #42a5f5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
        }

        .compliance-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .compliance-yes {
            background: #ff5722;
            color: white;
        }

        .compliance-no {
            background: #4caf50;
            color: white;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(40, 40, 60, 0.6);
            border-radius: 10px;
            border-left: 4px solid #42a5f5;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h3 {
            margin-bottom: 15px;
            color: #e0e0e0;
            font-size: 1.1em;
        }

        .jurisdiction-tag {
            display: inline-block;
            background: rgba(66, 165, 245, 0.2);
            color: #42a5f5;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            margin: 2px;
            font-weight: 500;
            border: 1px solid rgba(66, 165, 245, 0.3);
        }

        .risk-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #ff5722;
        }

        .risk-high {
            border-left-color: #f44336;
        }

        .risk-medium {
            border-left-color: #ff9800;
        }

        .risk-low {
            border-left-color: #4caf50;
        }

        .impl-step {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #4caf50;
            display: flex;
            align-items: center;
        }

        .priority-badge {
            background: #2196F3;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .citation {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff5722, #ff9800, #4caf50);
            transition: width 0.5s ease;
        }

        .metadata {
            font-size: 0.85em;
            color: #666;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 8px 16px;
            background: rgba(210, 105, 30, 0.1);
            color: #d2691e;
            border: 1px solid rgba(210, 105, 30, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
        }

        .preset-btn:hover {
            background: rgba(210, 105, 30, 0.2);
            color: #8b4513;
            box-shadow: 0 3px 10px rgba(210, 105, 30, 0.2);
        }

        .export-controls {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #e8d5c4;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .export-btn {
            background: linear-gradient(135deg, #d2691e, #cd853f);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'Georgia', serif;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(210, 105, 30, 0.2);
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(210, 105, 30, 0.3);
        }

        .export-btn.secondary {
            background: linear-gradient(135deg, #cd853f, #daa520);
        }

        .export-btn.tertiary {
            background: linear-gradient(135deg, #daa520, #b8860b);
        }

        .error {
            background: rgba(60, 20, 20, 0.8);
            color: #ff8a80;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .preset-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <h1 style="font-family: 'Times New Roman', serif; font-weight: 400; letter-spacing: 1px;">COMPLIANCE ANALYSIS REPORT</h1>
                    <p style="font-family: 'Times New Roman', serif; font-style: italic; opacity: 0.8;">Geo-Regulatory Assessment & Legal Compliance Framework</p>
                </div>
                <div style="text-align: right; opacity: 0.9;">
                    <div style="font-size: 0.9em; font-weight: 600; font-family: 'Times New Roman', serif;">Microsoft Phi-2 v5</div>
                    <div style="font-size: 0.8em; font-family: 'Times New Roman', serif;">Fine-tuned on 1,442 compliance pairs</div>
                    <div style="font-size: 0.75em; margin-top: 4px; color: #bdc3c7;">Enterprise Legal AI Platform</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="input-section">
                <!-- Export Controls at Top -->
                <div class="export-controls">
                    <h3 style="color: #2c3e50; margin-bottom: 15px; font-family: 'Georgia', serif; border-bottom: 2px solid #d2691e; padding-bottom: 8px;">
                        📋 Export & Documentation Tools
                    </h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
                        <button onclick="openDatasetExplorer()" class="export-btn">
                            📚 Training Dataset Explorer
                        </button>
                        <button onclick="exportComplianceReport()" class="export-btn secondary">
                            📊 Export Compliance Report (CSV)
                        </button>
                        <button onclick="exportAuditTrail()" class="export-btn tertiary">
                            📋 Export Audit Trail (CSV)
                        </button>
                    </div>
                </div>

                <!-- Feature Analysis Section -->
                <div style="background: rgba(255, 255, 255, 0.9); padding: 30px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #e8d5c4; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-family: 'Georgia', serif; display: flex; align-items: center; gap: 10px;">
                        ⚖️ Feature Compliance Analysis
                    </h2>
                    
                    <div style="background: rgba(210, 105, 30, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #d2691e; border: 1px solid rgba(210, 105, 30, 0.2);">
                        <div style="font-size: 1em; color: #d2691e; font-weight: 600; margin-bottom: 8px; font-family: 'Georgia', serif;">🏛️ Professional Compliance Assessment</div>
                        <div style="font-size: 0.9em; color: #2c3e50; line-height: 1.5; font-family: 'Georgia', serif;">
                            Analyze software features for geo-specific compliance requirements across global markets including GDPR (EU), CCPA (California), LGPD (Brazil), and 20+ other jurisdictions. Powered by Microsoft Phi-2 AI fine-tuned on 1,442 compliance examples.
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; font-family: 'Georgia', serif; display: flex; align-items: center; gap: 8px;">
                            🎯 Quick Analysis Templates
                        </h3>
                        <div class="preset-buttons">
                            <button class="preset-btn" onclick="loadPreset('gdpr')">🇪🇺 GDPR Cookies</button>
                            <button class="preset-btn" onclick="loadPreset('ccpa')">🇺🇸 CCPA Rights</button>
                            <button class="preset-btn" onclick="loadPreset('kids')">👶 Age Verification</button>
                            <button class="preset-btn" onclick="loadPreset('targeting')">🎯 Ad Targeting</button>
                            <button class="preset-btn" onclick="loadPreset('transparency')">📊 Transparency</button>
                            <button class="preset-btn" onclick="loadPreset('breach')">🚨 Data Breach</button>
                            <button class="preset-btn" onclick="loadPreset('audit')">📋 Audit Trails</button>
                            <button class="preset-btn" onclick="loadPreset('rights')">⚖️ User Rights</button>
                            <button class="preset-btn" onclick="loadPreset('sharing')">🤝 Data Sharing</button>
                            <button class="preset-btn" onclick="loadPreset('moderation')">🛡️ Content Moderation</button>
                            <button class="preset-btn" onclick="loadPreset('notice')">📢 Notice & Action</button>
                            <button class="preset-btn" onclick="loadPreset('supervisory')">🏛️ Supervisory Authority</button>
                            <button class="preset-btn" onclick="loadPreset('simple')">⚡ Simple Feature</button>
                        </div>
                    </div>

                    <form id="complianceForm">
                        <div class="form-group">
                            <label for="featureName">🏷️ Feature Name / Internal Codename</label>
                            <input type="text" id="featureName" placeholder="e.g., EU Cookie Consent Banner, LiveStreamGeoGate, UserDataExportTool" required>
                        </div>

                    <div class="form-group">
                        <label for="featureDescription">📝 Feature Description & Data Processing</label>
                        <textarea id="featureDescription" placeholder="Describe the feature functionality, what personal data is processed, user interactions, and geographic scope. Include any data collection, sharing, or storage aspects." required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="lawContext">⚖️ Known Legal Context (Optional)</label>
                        <textarea id="lawContext" placeholder='[{"law": "GDPR Article 7", "jurisdiction": "EU", "requirement": "Valid consent for data processing"}]'></textarea>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px;">
                            💡 Leave empty for automatic regulation detection, or provide known requirements in JSON format
                        </div>
                    </div>

                    <button type="submit" class="analyze-btn" id="analyzeBtn">
                        🔍 Screen for Geo-Compliance Requirements
                    </button>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    Analyzing with Phi-2 v5...
                </div>
            </div>

            <div class="output-section">
                <h2 style="margin-bottom: 25px; color: #2c3e50; font-family: 'Georgia', serif; font-size: 1.8em;">📊 Compliance Analysis Report</h2>
                
                <div id="results" class="result">
                    <!-- Results will be populated here -->
                </div>

                <div id="placeholder" style="text-align: center; color: #7f8c8d; padding: 50px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">⚖️</div>
                    <div style="font-size: 1.4em; font-weight: 600; margin-bottom: 15px; color: #2c3e50; font-family: 'Georgia', serif;">TikTok Global Compliance Screening</div>
                    <p style="line-height: 1.6; color: #34495e; font-size: 1.1em; font-family: 'Georgia', serif;">Enter feature details to automatically detect geo-specific legal requirements across global markets.</p>
                    <div style="margin-top: 25px; font-size: 1em; color: #7f8c8d; font-family: 'Georgia', serif;">
                        <strong style="color: #d2691e;">Key Benefits:</strong><br>
                        🛡️ Proactive legal guardrails before feature launch<br>
                        📋 Auditable compliance evidence<br>
                        🌍 Automated regulatory traceability
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ✅ Updated with your working Lambda Function URL
        const LAMBDA_FUNCTION_URL = 'https://vcf7glhsl7w4yccfzny6tigqmm0znsxx.lambda-url.us-west-2.on.aws/';

        const presets = {
            gdpr: {
                name: "TikTok EU Cookie Consent System",
                description: "Cookie consent management system for EU users accessing TikTok web platform. Displays consent banner with granular options for analytics, advertising, and personalization cookies. Processes user consent choices and stores preferences.",
                context: '[{"law": "GDPR Article 7", "jurisdiction": "EU", "requirement": "Valid consent for data processing"}, {"law": "GDPR Article 6", "jurisdiction": "EU", "requirement": "Lawful basis for processing personal data"}]'
            },
            ccpa: {
                name: "TikTok California Privacy Rights Portal",
                description: "Privacy dashboard for California users providing options to opt-out of personal data sale, delete account data, and access personal information. Integrates with TikTok's data infrastructure to process user privacy requests.",
                context: '[{"law": "CCPA Section 1798.135", "jurisdiction": "US-CA", "requirement": "Right to opt-out of sale of personal information"}, {"law": "CCPA Section 1798.105", "jurisdiction": "US-CA", "requirement": "Right to delete personal information"}]'
            },
            kids: {
                name: "TikTok Global Age Verification & Parental Controls",
                description: "Multi-jurisdictional age verification system that detects user age through behavioral analysis and account signals. Implements different consent flows for users under 13 (US), under 16 (EU), and under 18 (some jurisdictions).",
                context: '[{"law": "COPPA", "jurisdiction": "US", "requirement": "Parental consent for children under 13"}, {"law": "GDPR Article 8", "jurisdiction": "EU", "requirement": "Parental consent for children under 16"}, {"law": "UK ICO Age Appropriate Design Code", "jurisdiction": "UK", "requirement": "Privacy by design for children"}]'
            },
            targeting: {
                name: "Targeted Advertising Consent Manager",
                description: "Consent management for targeted advertising with granular options for analytics and marketing purposes. Includes targeting criteria disclosure and delivery controls, particularly for vulnerable users like minors.",
                context: '[{"law": "CELEX 32022R2065", "jurisdiction": "EU", "requirement": "Targeting criteria disclosure for advertisements"}]'
            },
            transparency: {
                name: "Transparency Reporting Dashboard",
                description: "Dashboard for transparency reporting with automated content moderation statistics, user request handling metrics, and regulatory compliance reporting for multiple jurisdictions.",
                context: '[{"law": "Utah Social Media Regulation", "jurisdiction": "US-UT", "requirement": "Social media transparency reporting"}]'
            },
            breach: {
                name: "Data Breach Notification System",
                description: "Automated system for data breach detection, assessment, and notification to relevant authorities and affected users across different jurisdictions with varying notification timelines.",
                context: '[{"law": "GDPR Article 33", "jurisdiction": "EU", "requirement": "72-hour breach notification"}, {"law": "CCPA Section 1798.82", "jurisdiction": "US-CA", "requirement": "California breach notification law"}]'
            },
            audit: {
                name: "Audit Trail & Logging System",
                description: "Comprehensive audit logging system that tracks user actions, data access, and system changes with configurable retention periods and access controls for regulatory compliance.",
                context: '[{"law": "GDPR Article 30", "jurisdiction": "EU", "requirement": "Records of processing activities"}, {"law": "SOX Section 404", "jurisdiction": "US", "requirement": "Internal controls documentation"}]'
            },
            rights: {
                name: "User Rights Management Portal",
                description: "Centralized portal for users to exercise their data protection rights including access, rectification, erasure, and portability with automated request processing and verification.",
                context: '[{"law": "GDPR Chapter 3", "jurisdiction": "EU", "requirement": "Data subject rights"}, {"law": "CCPA Section 1798.100", "jurisdiction": "US-CA", "requirement": "Consumer rights"}]'
            },
            sharing: {
                name: "Third-Party Data Sharing Controls",
                description: "Controls for third-party data sharing with consent management, partner verification, and data processing agreement enforcement across different jurisdictions.",
                context: '[{"law": "GDPR Article 28", "jurisdiction": "EU", "requirement": "Data processing agreements"}, {"law": "PIPEDA", "jurisdiction": "CA", "requirement": "Third-party disclosure requirements"}]'
            },
            moderation: {
                name: "Content Moderation Engine",
                description: "Automated content moderation system that analyzes user-generated content for policy violations, illegal content, and harmful material using AI algorithms and human review workflows.",
                context: '[{"law": "CELEX 32022R2065", "jurisdiction": "EU", "requirement": "Content moderation reporting requirements"}, {"law": "Section 230", "jurisdiction": "US", "requirement": "Platform liability protections"}]'
            },
            notice: {
                name: "Notice-and-Action Portal",
                description: "Portal for users to report illegal content and for platforms to take action on reported content with transparency mechanisms and appeal processes.",
                context: '[{"law": "CELEX 32022R2065", "jurisdiction": "EU", "requirement": "Notice and action mechanisms"}, {"law": "Florida Online Protections", "jurisdiction": "US-FL", "requirement": "Content reporting requirements"}]'
            },
            supervisory: {
                name: "Supervisory Authority Communication",
                description: "System for communicating with regulatory authorities, submitting compliance reports, and responding to supervisory inquiries across multiple jurisdictions.",
                context: '[{"law": "CELEX 32022R2065", "jurisdiction": "EU", "requirement": "Supervisory authority cooperation"}, {"law": "California Privacy Rights Act", "jurisdiction": "US-CA", "requirement": "CPPA enforcement"}]'
            },
            simple: {
                name: "TikTok Dark Mode Theme Toggle",
                description: "Simple UI preference toggle that allows users to switch between light and dark visual themes. Stores preference locally in browser settings without server-side data processing.",
                context: '[]'
            }
        };

        function loadPreset(type) {
            const preset = presets[type];
            document.getElementById('featureName').value = preset.name;
            document.getElementById('featureDescription').value = preset.description;
            document.getElementById('lawContext').value = preset.context;
        }

        function openDatasetExplorer() {
            const datasetContent = `
                <div style="background: rgba(248, 249, 250, 0.98); padding: 30px; border-radius: 8px; border: 2px solid #2c3e50; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); max-width: 800px; margin: 20px auto; font-family: 'Times New Roman', serif;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50; font-weight: 600; letter-spacing: 1px; margin-bottom: 10px;">TRAINING DATASET EXPLORER</h2>
                        <p style="color: #7f8c8d; font-style: italic;">Microsoft Phi-2 Fine-tuning Dataset Analysis</p>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 8px;">🧠 Training Process Overview</h3>
                        <div style="background: #ecf0f1; padding: 20px; border-radius: 6px; border-left: 4px solid #3498db; color: #34495e; line-height: 1.6;">
                            <strong>Fine-tuning Methodology:</strong> The Microsoft Phi-2 model was fine-tuned on 1,442 input-output pairs of geo-compliance analysis examples. Each training example contains a feature description, relevant law context, and the expected compliance assessment output. This enables the model to understand complex regulatory requirements across multiple jurisdictions.
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 8px;">📋 Sample Training Examples</h3>
                        <div style="display: grid; gap: 15px;">
                            <div style="background: #ecf0f1; padding: 15px; border-radius: 6px; border: 1px solid #bdc3c7;">
                                <div style="font-weight: 600; color: #e67e22; margin-bottom: 8px; font-size: 0.9em;">Example 1: Content Moderation Engine</div>
                                <div style="font-size: 0.85em; color: #34495e; margin-bottom: 6px;">
                                    <strong>Input:</strong> Feature analyzes user-generated content for policy violations using AI algorithms
                                </div>
                                <div style="font-size: 0.85em; color: #34495e; margin-bottom: 6px;">
                                    <strong>Law Context:</strong> EU DSA (CELEX 32022R2065) - Content moderation reporting requirements
                                </div>
                                <div style="font-size: 0.85em; color: #27ae60; font-weight: 600;">
                                    <strong>Output:</strong> "Needs Geo-Compliance" - EU-specific content moderation reporting required
                                </div>
                            </div>
                            
                            <div style="background: #ecf0f1; padding: 15px; border-radius: 6px; border: 1px solid #bdc3c7;">
                                <div style="font-weight: 600; color: #e67e22; margin-bottom: 8px; font-size: 0.9em;">Example 2: Notice-and-Action Portal</div>
                                <div style="font-size: 0.85em; color: #34495e; margin-bottom: 6px;">
                                    <strong>Input:</strong> Portal for users to report illegal content with transparency mechanisms
                                </div>
                                <div style="font-size: 0.85em; color: #34495e; margin-bottom: 6px;">
                                    <strong>Law Context:</strong> EU DSA + Florida Online Protections Act
                                </div>
                                <div style="font-size: 0.85em; color: #27ae60; font-weight: 600;">
                                    <strong>Output:</strong> "Needs Geo-Compliance" - Multi-jurisdictional notice mechanisms required
                                </div>
                            </div>
                            
                            <div style="background: #ecf0f1; padding: 15px; border-radius: 6px; border: 1px solid #bdc3c7;">
                                <div style="font-weight: 600; color: #e67e22; margin-bottom: 8px; font-size: 0.9em;">Example 3: Supervisory Authority Communication</div>
                                <div style="font-size: 0.85em; color: #34495e; margin-bottom: 6px;">
                                    <strong>Input:</strong> System for regulatory communication and compliance reporting
                                </div>
                                <div style="font-size: 0.85em; color: #34495e; margin-bottom: 6px;">
                                    <strong>Law Context:</strong> EU DSA + California Privacy Rights Act
                                </div>
                                <div style="font-size: 0.85em; color: #27ae60; font-weight: 600;">
                                    <strong>Output:</strong> "Needs Geo-Compliance" - Authority communication protocols required
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #d5f4e6; padding: 20px; border-radius: 6px; border-left: 4px solid #27ae60;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">🎯 Dataset Statistics</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; font-size: 0.9em; color: #34495e;">
                            <div><strong>Total Examples:</strong> 1,442</div>
                            <div><strong>Jurisdictions Covered:</strong> 15+</div>
                            <div><strong>Laws Analyzed:</strong> 25+</div>
                            <div><strong>Compliance Flags:</strong> 3 types</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px;">
                        <button onclick="closeDatasetExplorer()" style="background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-family: 'Times New Roman', serif; font-weight: 600; cursor: pointer;">
                            Close Explorer
                        </button>
                    </div>
                </div>
            `;
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'datasetOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            overlay.innerHTML = datasetContent;
            document.body.appendChild(overlay);
        }

        function closeDatasetExplorer() {
            const overlay = document.getElementById('datasetOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function exportComplianceReport() {
            const reportId = `RPT-${Date.now().toString().slice(-6)}`;
            const timestamp = new Date().toISOString();
            const featureName = document.getElementById('featureName').value;
            const featureDescription = document.getElementById('featureDescription').value;
            
            // Get current analysis data
            const resultsDiv = document.getElementById('results');
            if (!resultsDiv.innerHTML.includes('COMPLIANCE ANALYSIS REPORT')) {
                alert('Please run a compliance analysis first.');
                return;
            }

            // Extract analysis data from the current display
            const analysis = window.currentAnalysis || {};
            
            // Create CSV content
            const csvContent = [
                // Header
                ['COMPLIANCE ANALYSIS REPORT - EXPORT'],
                ['Generated:', timestamp],
                ['Report ID:', reportId],
                [''],
                
                // Feature Information
                ['FEATURE INFORMATION'],
                ['Feature Name:', featureName],
                ['Feature Description:', featureDescription],
                [''],
                
                // Compliance Assessment
                ['COMPLIANCE ASSESSMENT'],
                ['Geo-Compliance Required:', analysis.hasGeoCompliance ? 'YES' : 'NO'],
                ['Compliance Score:', `${analysis.complianceScore || 85}%`],
                ['Risk Level:', (analysis.riskLevel || 'medium').toUpperCase()],
                [''],
                
                // Executive Summary
                ['EXECUTIVE SUMMARY'],
                ['Summary:', analysis.summary || 'No summary available'],
                [''],
                
                // Affected Jurisdictions
                ['AFFECTED JURISDICTIONS'],
                ['Code', 'Name', 'Flag', 'Color'],
                ...(analysis.jurisdictions || []).map(j => [j.code, j.name, j.flag, j.color]),
                [''],
                
                // Legal Requirements
                ['LEGAL REQUIREMENTS'],
                ['Law Code', 'Full Name', 'Article', 'Description', 'Color'],
                ...(analysis.laws || []).map(law => [
                    law.name, 
                    law.fullName, 
                    law.article || 'N/A', 
                    law.description, 
                    law.color
                ]),
                [''],
                
                // Implementation Requirements
                ['IMPLEMENTATION REQUIREMENTS'],
                ['Task Number', 'Requirement', 'Priority', 'Estimated Effort'],
                ...(analysis.requirements || []).map((req, index) => {
                    const priority = index === 0 ? 'Critical' : index === 1 ? 'High' : 'Medium';
                    const effort = index === 0 ? '2-3 sprints' : index === 1 ? '1-2 sprints' : '1 sprint';
                    return [`Task ${index + 1}`, req, priority, effort];
                }),
                [''],
                
                // Model Information
                ['MODEL INFORMATION'],
                ['AI Model:', 'Microsoft Phi-2 v5'],
                ['Training Dataset:', '1,442 compliance examples'],
                ['Specialization:', 'Geo-Compliance Analysis'],
                ['Processing Length:', `${window.currentMetadata?.response_length || 0} characters`],
                [''],
                
                // Audit Information
                ['AUDIT INFORMATION'],
                ['Analysis Timestamp:', timestamp],
                ['Platform:', 'TikTok Enterprise Compliance Platform'],
                ['AI Provider:', 'Microsoft Phi-2 LLM'],
                ['Infrastructure:', 'AWS SageMaker'],
                ['Export Generated:', new Date().toISOString()]
            ];

            // Convert to CSV string
            const csvString = csvContent.map(row => 
                row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            // Download file
            downloadCSV(csvString, `compliance_report_${reportId}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportAuditTrail() {
            const reportId = `RPT-${Date.now().toString().slice(-6)}`;
            const timestamp = new Date().toISOString();
            const featureName = document.getElementById('featureName').value;
            
            // Create comprehensive audit trail
            const auditTrail = [
                // Header
                ['AUDIT TRAIL - COMPLIANCE ANALYSIS'],
                ['Generated:', timestamp],
                ['Report ID:', reportId],
                [''],
                
                // Analysis Session
                ['ANALYSIS SESSION'],
                ['Session Start:', timestamp],
                ['Feature Analyzed:', featureName],
                ['Analysis Type:', 'Geo-Compliance Assessment'],
                ['AI Model Used:', 'Microsoft Phi-2 v5'],
                ['Training Dataset Size:', '1,442 examples'],
                [''],
                
                // Input Data
                ['INPUT DATA'],
                ['Feature Name:', featureName],
                ['Feature Description:', document.getElementById('featureDescription').value],
                ['Law Context:', document.getElementById('lawContext').value],
                [''],
                
                // Processing Details
                ['PROCESSING DETAILS'],
                ['Model Endpoint:', 'phi2-v5-inference'],
                ['Processing Time:', `${window.currentMetadata?.response_length || 0} characters processed`],
                ['Analysis Method:', 'Fine-tuned LLM with geo-compliance specialization'],
                [''],
                
                // Output Analysis
                ['OUTPUT ANALYSIS'],
                ['Raw Model Response:', window.currentRawResponse || 'Not available'],
                ['Parsed Compliance Flag:', window.currentAnalysis?.hasGeoCompliance ? 'YES' : 'NO'],
                ['Compliance Score:', `${window.currentAnalysis?.complianceScore || 85}%`],
                ['Risk Assessment:', (window.currentAnalysis?.riskLevel || 'medium').toUpperCase()],
                [''],
                
                // Jurisdictions Identified
                ['JURISDICTIONS IDENTIFIED'],
                ['Jurisdiction Code', 'Jurisdiction Name', 'Detection Method'],
                ...(window.currentAnalysis?.jurisdictions || []).map(j => [j.code, j.name, 'AI Analysis']),
                [''],
                
                // Laws Referenced
                ['LAWS REFERENCED'],
                ['Law Code', 'Full Name', 'Article', 'Relevance Score'],
                ...(window.currentAnalysis?.laws || []).map(law => [
                    law.name, 
                    law.fullName, 
                    law.article || 'N/A', 
                    'High'
                ]),
                [''],
                
                // Implementation Actions
                ['IMPLEMENTATION ACTIONS'],
                ['Action ID', 'Description', 'Priority', 'Effort Estimate', 'Compliance Impact'],
                ...(window.currentAnalysis?.requirements || []).map((req, index) => {
                    const priority = index === 0 ? 'Critical' : index === 1 ? 'High' : 'Medium';
                    const effort = index === 0 ? '2-3 sprints' : index === 1 ? '1-2 sprints' : '1 sprint';
                    const impact = index === 0 ? 'High' : index === 1 ? 'Medium' : 'Low';
                    return [`ACT-${index + 1}`, req, priority, effort, impact];
                }),
                [''],
                
                // Technical Metadata
                ['TECHNICAL METADATA'],
                ['Model Version:', 'Phi-2 v5'],
                ['Training Examples:', '1,442'],
                ['Specialization:', 'Geo-Compliance Analysis'],
                ['Processing Framework:', 'AWS SageMaker'],
                ['Response Format:', 'JSON'],
                [''],
                
                // Audit Trail
                ['AUDIT TRAIL'],
                ['Event', 'Timestamp', 'Details'],
                ['Analysis Requested', timestamp, `Feature: ${featureName}`],
                ['Model Invoked', timestamp, 'Microsoft Phi-2 v5'],
                ['Response Generated', timestamp, 'Compliance assessment completed'],
                ['Results Parsed', timestamp, 'Structured data extracted'],
                ['Report Generated', timestamp, 'Compliance report created'],
                ['Export Created', new Date().toISOString(), 'Audit trail exported'],
                [''],
                
                // Compliance Framework
                ['COMPLIANCE FRAMEWORK'],
                ['Framework Type:', 'Multi-Jurisdictional Privacy Law Analysis'],
                ['Coverage:', 'GDPR, CCPA, LGPD, PIPEDA, and 20+ other regulations'],
                ['Analysis Depth:', 'Feature-level compliance assessment'],
                ['Risk Assessment:', 'Automated risk level calculation'],
                [''],
                
                // Export Information
                ['EXPORT INFORMATION'],
                ['Export Type:', 'Audit Trail CSV'],
                ['Export Timestamp:', new Date().toISOString()],
                ['Export Purpose:', 'Compliance Documentation'],
                ['Data Retention:', 'Audit-ready format for regulatory review'],
                ['Generated By:', 'TikTok Enterprise Compliance Platform'],
                ['AI Model:', 'Microsoft Phi-2 v5 Fine-tuned']
            ];

            // Convert to CSV string
            const csvString = auditTrail.map(row => 
                row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            // Download file
            downloadCSV(csvString, `audit_trail_${reportId}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        document.getElementById('complianceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const featureName = document.getElementById('featureName').value;
            const featureDescription = document.getElementById('featureDescription').value;
            const lawContext = document.getElementById('lawContext').value;

            if (!LAMBDA_FUNCTION_URL || LAMBDA_FUNCTION_URL === 'YOUR_LAMBDA_FUNCTION_URL_HERE') {
                showError('Please update the LAMBDA_FUNCTION_URL in the JavaScript code with your actual Lambda Function URL.');
                return;
            }

            // Show loading
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('placeholder').style.display = 'none';

            try {
                const payload = {
                    instruction: "Analyse the feature artifact and decide if geo-specific compliance logic is needed. Explain why and cite the relevant regulation if any.",
                    input: `Feature Name: ${featureName}\nFeature Description: ${featureDescription}\n\nLaw Context (structured JSON):\n${lawContext}`
                };

                const response = await fetch(LAMBDA_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                displayResults(result);

            } catch (error) {
                console.error('Error:', error);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        });

        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            
            if (!result.success) {
                showError('Analysis failed: ' + (result.error?.message || 'Unknown error'));
                return;
            }

            // Extract the generated text from Phi-2 response
            const generatedText = result.analysis?.generated_text || '';
            const metadata = result.metadata || {};
            
            // Enhanced parsing to extract structured information
            const analysis = parseAnalysis(generatedText);
            
            // Store analysis data globally for export functions
            window.currentAnalysis = analysis;
            window.currentMetadata = metadata;
            window.currentRawResponse = generatedText;
            
            resultsDiv.innerHTML = `
                <!-- Legal Document Header -->
                <div style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 10px; margin-bottom: 30px; border: 2px solid #d2691e; box-shadow: 0 4px 15px rgba(210, 105, 30, 0.1);">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start;">
                        <div>
                            <div style="font-size: 2.2em; font-weight: 600; color: #2c3e50; margin-bottom: 15px; font-family: 'Georgia', serif; letter-spacing: 0.5px;">
                                COMPLIANCE ANALYSIS REPORT
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div style="background: ${analysis.hasGeoCompliance ? '#d2691e' : '#27ae60'}; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; font-weight: 600; font-family: 'Georgia', serif;">
                                    ${analysis.hasGeoCompliance ? 'GEO-SPECIFIC COMPLIANCE REQUIRED' : 'STANDARD IMPLEMENTATION SUFFICIENT'}
                                </div>
                                <div style="background: #cd853f; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; font-weight: 600; font-family: 'Georgia', serif;">
                                    COMPLIANCE SCORE: ${analysis.complianceScore}%
                                </div>
                                <div style="background: #daa520; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; font-weight: 600; font-family: 'Georgia', serif;">
                                    RISK LEVEL: ${analysis.riskLevel.toUpperCase()}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right; background: #ecf0f1; padding: 12px; border-radius: 3px; border: 1px solid #bdc3c7;">
                            <div style="font-size: 0.75em; color: #7f8c8d; margin-bottom: 3px; font-family: 'Times New Roman', serif;">REPORT ID</div>
                            <div style="font-size: 0.9em; font-weight: bold; color: #2c3e50; margin-bottom: 5px; font-family: 'Times New Roman', serif;">RPT-${Date.now().toString().slice(-6)}</div>
                            <div style="font-size: 0.75em; color: #7f8c8d; font-family: 'Times New Roman', serif;">${new Date().toLocaleString()}</div>
                        </div>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div class="section" style="border-left: 4px solid ${analysis.hasGeoCompliance ? '#d2691e' : '#27ae60'}; margin-bottom: 25px;">
                    <details open>
                        <summary style="cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 600; color: #2c3e50; font-family: 'Georgia', serif; font-size: 1.2em;">
                            <span style="font-size: 1.3em;">📋</span>
                            <span>EXECUTIVE SUMMARY</span>
                        </summary>
                        <div style="background: rgba(255, 255, 255, 0.95); padding: 25px; border-radius: 8px; font-size: 1.1em; line-height: 1.6; border: 1px solid #e8d5c4; box-shadow: 0 2px 8px rgba(210, 105, 30, 0.1);">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 15px; font-family: 'Georgia', serif; font-size: 1.1em;">
                                ${analysis.hasGeoCompliance ? 'GEO-SPECIFIC REQUIREMENTS DETECTED' : 'STANDARD IMPLEMENTATION SUFFICIENT'}
                    </div>
                            <div style="color: #34495e; background: rgba(210, 105, 30, 0.1); padding: 20px; border-radius: 6px; border-left: 4px solid #d2691e; max-height: 150px; overflow-y: auto; font-family: 'Georgia', serif; font-size: 1em;">
                                ${analysis.summary.replace(/\n/g, '<br>').slice(0, 400)}${analysis.summary.length > 400 ? '...' : ''}
                </div>
                        </div>
                    </details>
                </div>

                ${analysis.jurisdictions.length > 0 ? `
                <div class="section" style="margin-bottom: 20px;">
                    <details open>
                        <summary style="cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 600; color: #e0e0e0;">
                            <span style="font-size: 1.1em;">🌍</span>
                            <span>Affected Jurisdictions</span>
                            <span style="background: rgba(66, 165, 245, 0.2); color: #42a5f5; padding: 3px 10px; border-radius: 10px; font-size: 0.75em; font-weight: normal;">${analysis.jurisdictions.length}</span>
                        </summary>
                        <div style="background: rgba(40, 40, 60, 0.8); padding: 15px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${analysis.jurisdictions.map(j => `
                                    <div style="background: linear-gradient(135deg, rgba(${j.color.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(', ')}, 0.15), rgba(${j.color.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(', ')}, 0.05)); border: 1px solid rgba(${j.color.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(', ')}, 0.3); padding: 10px 15px; border-radius: 8px; text-align: center; min-width: 120px;">
                                        <div style="font-size: 1.5em; margin-bottom: 5px;">${j.flag}</div>
                                        <div style="font-weight: 600; color: ${j.color}; font-size: 0.9em;">${j.code}</div>
                                        <div style="font-size: 0.8em; color: #e0e0e0;">${j.name}</div>
                        </div>
                    `).join('')}
                </div>
                    </div>
                    </details>
                </div>
                ` : ''}

                ${analysis.laws.length > 0 ? `
                <div class="section" style="margin-bottom: 20px;">
                    <details>
                        <summary style="cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 600; color: #e0e0e0;">
                            <span style="font-size: 1.1em;">⚖️</span>
                            <span>Legal Requirements</span>
                            <span style="background: rgba(244, 67, 54, 0.2); color: #f44336; padding: 3px 10px; border-radius: 10px; font-size: 0.75em; font-weight: normal;">${analysis.laws.length}</span>
                        </summary>
                        <div style="background: rgba(40, 40, 60, 0.8); padding: 15px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="display: grid; gap: 12px;">
                                ${analysis.laws.map(law => `
                                    <div style="background: linear-gradient(135deg, rgba(${law.color.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(', ')}, 0.15), rgba(${law.color.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(', ')}, 0.05)); border: 1px solid rgba(${law.color.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(', ')}, 0.3); padding: 12px; border-radius: 8px;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                            <span style="font-size: 1.3em;">${law.icon}</span>
                    <div>
                                                <div style="font-weight: bold; color: ${law.color}; font-size: 1em;">${law.name}${law.article ? ` Article ${law.article}` : ''}</div>
                                                <div style="font-size: 0.8em; color: #a0a0a0;">${law.fullName}</div>
                    </div>
                                        </div>
                                        <div style="color: #e0e0e0; font-size: 0.85em; line-height: 1.4;">${law.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </details>
                </div>
                ` : ''}

                ${analysis.requirements.length > 0 ? `
                <div class="section" style="margin-bottom: 20px;">
                    <details>
                        <summary style="cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 600; color: #e0e0e0;">
                            <span style="font-size: 1.1em;">⚡</span>
                            <span>Implementation Action Items</span>
                            <span style="background: rgba(255, 193, 7, 0.2); color: #ffc107; padding: 3px 10px; border-radius: 10px; font-size: 0.75em; font-weight: normal;">${analysis.requirements.length}</span>
                        </summary>
                        <div style="background: rgba(40, 40, 60, 0.8); padding: 15px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="font-size: 0.85em; color: #a0a0a0; margin-bottom: 15px; padding: 10px; background: rgba(66, 165, 245, 0.1); border-radius: 6px; border-left: 3px solid #42a5f5;">
                                💡 <strong>Engineering Guidance:</strong> Prioritized implementation tasks
                            </div>
                            <div style="display: grid; gap: 12px; max-height: 300px; overflow-y: auto;">
                                ${analysis.requirements.map((req, index) => {
                                    const priority = index === 0 ? 'Critical' : index === 1 ? 'High' : 'Medium';
                                    const effort = index === 0 ? '2-3 sprints' : index === 1 ? '1-2 sprints' : '1 sprint';
                                    const priorityColor = index === 0 ? '#f44336' : index === 1 ? '#ff9800' : '#4caf50';
                                    return `
                                    <div style="background: linear-gradient(135deg, rgba(60, 60, 80, 0.8), rgba(50, 50, 70, 0.8)); border: 1px solid rgba(255, 255, 255, 0.1); padding: 12px; border-radius: 8px; border-left: 4px solid ${priorityColor};">
                                        <div style="display: flex; align-items: start; gap: 12px;">
                                            <div style="background: ${priorityColor}; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8em; flex-shrink: 0; margin-top: 1px;">${index + 1}</div>
                                            <div style="flex: 1;">
                                                <div style="color: #e8e8e8; font-size: 0.9em; line-height: 1.5; margin-bottom: 8px;">
                                                    <strong>Task ${index + 1}:</strong> ${req.charAt(0).toUpperCase() + req.slice(1).slice(0, 100)}${req.length > 100 ? '...' : ''}
                                                </div>
                                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                                    <div style="background: rgba(${priorityColor.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(', ')}, 0.2); color: ${priorityColor}; padding: 4px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 600;">
                                                        ${priority}
                                                    </div>
                                                    <div style="background: rgba(66, 165, 245, 0.2); color: #42a5f5; padding: 4px 8px; border-radius: 12px; font-size: 0.75em;">
                                                        ${effort}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    </details>
                </div>
                ` : ''}

                <div class="section" style="margin-bottom: 15px;">
                    <details>
                        <summary style="cursor: pointer; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; font-weight: 600; color: #e0e0e0;">
                            <span style="font-size: 1.1em;">🧠</span>
                            <span>Microsoft Phi-2 Model Details</span>
                        </summary>
                        <div style="background: rgba(40, 40, 60, 0.8); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                                <div>
                                    <div style="font-size: 0.75em; color: #a0a0a0; margin-bottom: 4px;">AI Model</div>
                                    <div style="font-size: 1em; font-weight: bold; color: #42a5f5;">Microsoft Phi-2 v5</div>
                        </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #a0a0a0; margin-bottom: 4px;">Training Dataset</div>
                                    <div style="font-size: 1em; font-weight: bold; color: #42a5f5;">1,442 compliance pairs</div>
                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #a0a0a0; margin-bottom: 4px;">Specialization</div>
                                    <div style="font-size: 1em; font-weight: bold; color: #42a5f5;">Geo-Compliance Analysis</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.75em; color: #a0a0a0; margin-bottom: 4px;">Processing</div>
                                    <div style="font-size: 1em; font-weight: bold; color: #42a5f5;">${metadata.response_length || 0} chars</div>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>

                ${result.analysis?.raw_response ? `
                <div class="section">
                    <h3>🔍 Technical Details</h3>
                    <details style="background: rgba(40, 40, 60, 0.8); padding: 15px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <summary style="cursor: pointer; font-weight: bold; margin-bottom: 10px; color: #e0e0e0;">View Raw Model Response</summary>
                        <pre style="background: rgba(20, 20, 30, 0.8); color: #e0e0e0; padding: 10px; border-radius: 4px; font-size: 0.85em; overflow-x: auto; white-space: pre-wrap; border: 1px solid rgba(255, 255, 255, 0.1);">${JSON.stringify(result.analysis.raw_response, null, 2)}</pre>
                    </details>
                </div>
                ` : ''}

                <div style="background: rgba(30, 30, 45, 0.9); padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid rgba(255, 255, 255, 0.2);">
                    <details>
                        <summary style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #e0e0e0;">
                            <span>📊 Audit Trail & Metadata</span>
                            <span style="font-size: 0.8em; color: #a0a0a0;">For Documentation</span>
                        </summary>
                        <div style="margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; font-size: 0.8em; color: #e0e0e0;">
                                <div>
                                    <strong style="color: #42a5f5;">Model:</strong> Microsoft Phi-2 v5<br>
                                    <strong style="color: #42a5f5;">Dataset:</strong> 1,442 compliance examples<br>
                                    <strong style="color: #42a5f5;">Framework:</strong> Multi-jurisdictional analysis
                    </div>
                                <div>
                                    <strong style="color: #42a5f5;">Timestamp:</strong> ${new Date().toLocaleString()}<br>
                                    <strong style="color: #42a5f5;">Processing:</strong> ${metadata.response_length || 0} chars<br>
                                    <strong style="color: #42a5f5;">Endpoint:</strong> AWS SageMaker
                                </div>
                            </div>
                            <div style="text-align: center; margin-top: 12px; font-size: 0.75em; color: #a0a0a0; border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 8px;">
                                🏢 TikTok Enterprise Compliance Platform • Microsoft Phi-2 LLM • Audit-ready Documentation
                            </div>
                        </div>
                    </details>
                </div>


            `;

            resultsDiv.style.display = 'block';
        }

        function parseAnalysis(text) {
            const analysis = {
                hasGeoCompliance: false,
                summary: '',
                jurisdictions: [],
                laws: [],
                requirements: [],
                riskLevel: 'low',
                complianceScore: 85
            };

            // Enhanced geo-compliance detection
            const geoKeywords = ['geo', 'jurisdiction', 'eu', 'gdpr', 'ccpa', 'california', 'us-ca', 'privacy', 'consent', 'data protection'];
            analysis.hasGeoCompliance = geoKeywords.some(keyword => text.toLowerCase().includes(keyword));

            // Clean and format the summary
            analysis.summary = text.replace(/\n{2,}/g, '\n').trim();
            
            // Enhanced jurisdiction extraction with better patterns
            const jurisdictionMap = {
                'eu': { code: 'EU', name: 'European Union', flag: '🇪🇺', color: '#1976d2' },
                'california': { code: 'US-CA', name: 'California', flag: '🇺🇸', color: '#d32f2f' },
                'us-ca': { code: 'US-CA', name: 'California', flag: '🇺🇸', color: '#d32f2f' },
                'canada': { code: 'CA', name: 'Canada', flag: '🇨🇦', color: '#388e3c' },
                'brazil': { code: 'BR', name: 'Brazil', flag: '🇧🇷', color: '#388e3c' },
                'uk': { code: 'UK', name: 'United Kingdom', flag: '🇬🇧', color: '#1976d2' }
            };

            Object.keys(jurisdictionMap).forEach(key => {
                if (text.toLowerCase().includes(key)) {
                    const jurisdiction = jurisdictionMap[key];
                    if (!analysis.jurisdictions.some(j => j.code === jurisdiction.code)) {
                        analysis.jurisdictions.push(jurisdiction);
                    }
                }
            });

            // Enhanced law extraction with better formatting
            const lawRegex = /(GDPR|CCPA|COPPA|LGPD|PIPEDA)(\s+(?:Article|Section)\s*(\d+(?:\.\d+)?|\w+))?/gi;
            const lawMatches = text.matchAll(lawRegex);
            
            for (const match of lawMatches) {
                const lawName = match[1].toUpperCase();
                const article = match[3] || '';
                const fullName = getLawFullName(lawName);
                
                if (!analysis.laws.some(law => law.name === lawName && law.article === article)) {
                    analysis.laws.push({
                        name: lawName,
                        fullName: fullName,
                        article: article,
                        description: generateLawDescription(lawName, article),
                        color: getLawColor(lawName),
                        icon: getLawIcon(lawName)
                    });
                }
            }

            // Enhanced requirement extraction
            const reqPatterns = [
                /(?:must|need to|should|require[sd]?)\s+([^.!?]+)/gi,
                /(?:provide|implement|enable|ensure)\s+([^.!?]+)/gi
            ];

            reqPatterns.forEach(pattern => {
                const matches = text.matchAll(pattern);
                for (const match of matches) {
                    let requirement = match[1].trim();
                    requirement = requirement.charAt(0).toLowerCase() + requirement.slice(1);
                    if (requirement.length > 15 && requirement.length < 150 && 
                        !analysis.requirements.includes(requirement)) {
                        analysis.requirements.push(requirement);
                    }
                }
            });

            // Calculate risk level and compliance score
            analysis.riskLevel = calculateRiskLevel(analysis);
            analysis.complianceScore = calculateComplianceScore(analysis);

            return analysis;
        }

        function getLawFullName(lawCode) {
            const lawNames = {
                'GDPR': 'General Data Protection Regulation',
                'CCPA': 'California Consumer Privacy Act',
                'COPPA': 'Children\'s Online Privacy Protection Act',
                'LGPD': 'Lei Geral de Proteção de Dados',
                'PIPEDA': 'Personal Information Protection and Electronic Documents Act'
            };
            return lawNames[lawCode] || lawCode;
        }

        function getLawColor(lawCode) {
            const colors = {
                'GDPR': '#1976d2',
                'CCPA': '#d32f2f',
                'COPPA': '#388e3c',
                'LGPD': '#f57c00',
                'PIPEDA': '#7b1fa2'
            };
            return colors[lawCode] || '#42a5f5';
        }

        function getLawIcon(lawCode) {
            const icons = {
                'GDPR': '🇪🇺',
                'CCPA': '🇺🇸',
                'COPPA': '👶',
                'LGPD': '🇧🇷',
                'PIPEDA': '🇨🇦'
            };
            return icons[lawCode] || '⚖️';
        }

        function generateLawDescription(lawCode, article) {
            const descriptions = {
                'GDPR': article ? `GDPR Article ${article} compliance requirement` : 'General EU data protection requirement',
                'CCPA': article ? `CCPA Section ${article} compliance requirement` : 'California privacy rights requirement',
                'COPPA': 'Children\'s privacy protection requirement',
                'LGPD': 'Brazilian data protection requirement',
                'PIPEDA': 'Canadian privacy law requirement'
            };
            return descriptions[lawCode] || `${lawCode} compliance requirement`;
        }

        function calculateRiskLevel(analysis) {
            if (analysis.laws.length >= 3) return 'high';
            if (analysis.laws.length >= 2 || analysis.jurisdictions.length >= 2) return 'medium';
            if (analysis.hasGeoCompliance) return 'medium';
            return 'low';
        }

        function calculateComplianceScore(analysis) {
            let score = 100;
            score -= analysis.laws.length * 10;
            score -= analysis.jurisdictions.length * 5;
            score -= analysis.requirements.length * 3;
            return Math.max(score, 20);
        }

        function showError(message) {
            document.getElementById('results').innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${message}
                </div>
            `;
            document.getElementById('results').style.display = 'block';
        }

        // Load GDPR preset by default
        loadPreset('gdpr');
    </script>
</body>
</html>
