<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi-2 v5 Geo-Compliance Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: linear-gradient(135deg, #fff5f0 0%, #ffe8d6 50%, #ffdab9 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: #2c3e50;
        }

        .container {
            width: 100%;
            max-width: none;
            margin: 0;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            border: none;
        }

        .navbar {
            background: linear-gradient(135deg, #d2691e 0%, #cd853f 50%, #daa520 100%);
            color: #fff;
            padding: 15px 40px;
            border-bottom: 3px solid #8b4513;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .navbar-brand h1 {
            font-size: 1.8em;
            font-weight: 600;
            font-family: 'Georgia', serif;
            margin: 0;
        }

        .navbar-brand p {
            font-size: 0.9em;
            opacity: 0.95;
            font-style: italic;
            margin: 0;
        }

        .navbar-ai {
            text-align: right;
            opacity: 0.9;
        }

        .navbar-ai div {
            font-size: 0.8em;
            font-family: 'Georgia', serif;
            margin: 2px 0;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 80vh;
        }

        .input-section {
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            border-right: 2px solid #e8d5c4;
            max-height: 80vh;
            overflow-y: auto;
        }

        .output-section {
            padding: 40px;
            background: rgba(255, 255, 255, 0.95);
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95em;
            font-family: 'Georgia', serif;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e8d5c4;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #2c3e50;
            font-family: 'Georgia', serif;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #d2691e;
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 0 10px rgba(210, 105, 30, 0.2);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #7f8c8d;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .analyze-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #d2691e, #cd853f);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(210, 105, 30, 0.3);
            font-family: 'Georgia', serif;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(210, 105, 30, 0.4);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #a0a0a0;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #42a5f5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result {
            display: none;
        }

        .compliance-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .compliance-yes {
            background: #ff5722;
            color: white;
        }

        .compliance-no {
            background: #4caf50;
            color: white;
        }

        .section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(40, 40, 60, 0.6);
            border-radius: 10px;
            border-left: 4px solid #42a5f5;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h3 {
            margin-bottom: 15px;
            color: #e0e0e0;
            font-size: 1.1em;
        }

        .jurisdiction-tag {
            display: inline-block;
            background: rgba(66, 165, 245, 0.2);
            color: #42a5f5;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            margin: 2px;
            font-weight: 500;
            border: 1px solid rgba(66, 165, 245, 0.3);
        }

        .risk-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #ff5722;
        }

        .risk-high {
            border-left-color: #f44336;
        }

        .risk-medium {
            border-left-color: #ff9800;
        }

        .risk-low {
            border-left-color: #4caf50;
        }

        .impl-step {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #4caf50;
            display: flex;
            align-items: center;
        }

        .priority-badge {
            background: #2196F3;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .citation {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff5722, #ff9800, #4caf50);
            transition: width 0.5s ease;
        }

        .metadata {
            font-size: 0.85em;
            color: #666;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 8px 16px;
            background: rgba(210, 105, 30, 0.1);
            color: #d2691e;
            border: 1px solid rgba(210, 105, 30, 0.3);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
            font-family: 'Georgia', serif;
        }

        .preset-btn:hover {
            background: rgba(210, 105, 30, 0.2);
            color: #8b4513;
            box-shadow: 0 3px 10px rgba(210, 105, 30, 0.2);
        }

        .export-controls {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #e8d5c4;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .export-btn {
            background: linear-gradient(135deg, #d2691e, #cd853f);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'Georgia', serif;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(210, 105, 30, 0.2);
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(210, 105, 30, 0.3);
        }

        .export-btn.secondary {
            background: linear-gradient(135deg, #cd853f, #daa520);
        }

        .export-btn.tertiary {
            background: linear-gradient(135deg, #daa520, #b8860b);
        }

        .error {
            background: rgba(60, 20, 20, 0.8);
            color: #ff8a80;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f44336;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .input-section {
                border-right: none;
                border-bottom: 1px solid #dee2e6;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .preset-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navbar">
            <div class="navbar-brand">
                <div style="font-size: 1.5em;">⚖️</div>
                <div>
                    <h1>TikTok Geo-Regulation Governance</h1>
                    <p>From Guesswork to Governance: Automated Compliance Analysis</p>
                    <a href="https://github.com/Arnie016/Tiktok-TECHJAM" target="_blank" style="color: white; text-decoration: none; font-size: 0.8em; opacity: 0.9; transition: opacity 0.3s ease; margin-top: 5px; display: inline-block;">
                        📚 GitHub Repository
                    </a>
                </div>
            </div>
            <div class="navbar-controls">
                <button onclick="toggleChat()" style="background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-size: 0.9em;">
                    💬 AI Chat
                </button>
            </div>
            <div class="navbar-ai">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="text-align: right;">
                        <div style="font-size: 0.9em; font-weight: 600; margin-bottom: 2px;">🧠 Microsoft Phi-2 v5</div>
                        <div style="font-size: 0.75em; opacity: 0.9;">Fine-tuned on 1,442 compliance pairs</div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="openDatasetExplorer()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8em; cursor: pointer; font-family: 'Georgia', serif; transition: all 0.3s ease;">
                            📚 Dataset
                        </button>
                        <button onclick="exportComplianceReport()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8em; cursor: pointer; font-family: 'Georgia', serif; transition: all 0.3s ease;">
                            📊 Export
                        </button>
                        <button onclick="exportAuditTrail()" style="background: rgba(255, 255, 255, 0.2); color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.8em; cursor: pointer; font-family: 'Georgia', serif; transition: all 0.3s ease;">
                            📋 Audit
                        </button>
        </div>

                </div>
            </div>
        </div>

        <!-- Analysis Tool Section (Visible by default) -->
        <div id="analysisTool" style="display: block;">
        <div class="main-content">
                <!-- Left Panel: Input Section -->
                <div class="input-section" style="padding: 30px; background: rgba(255, 255, 255, 0.95); border-right: 2px solid #e8d5c4;">

                    <!-- Feature Analysis Section -->
                    <div style="background: rgba(255, 255, 255, 0.9); padding: 30px; border-radius: 10px; margin-bottom: 30px; border: 1px solid #e8d5c4; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);">
                        <h2 style="margin-bottom: 25px; color: #2c3e50; font-family: 'Georgia', serif; display: flex; align-items: center; gap: 10px;">
                            ⚖️ Feature Compliance Analysis
                        </h2>
                        
                        <div style="background: rgba(210, 105, 30, 0.1); padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #d2691e; border: 1px solid rgba(210, 105, 30, 0.2);">
                            <div style="font-size: 1em; color: #d2691e; font-weight: 600; margin-bottom: 8px; font-family: 'Georgia', serif;">🏛️ Professional Compliance Assessment</div>
                            <div style="font-size: 0.9em; color: #2c3e50; line-height: 1.5; font-family: 'Georgia', serif;">
                                Analyze software features for geo-specific compliance requirements across global markets including GDPR (EU), CCPA (California), LGPD (Brazil), and 20+ other jurisdictions. Powered by Microsoft Phi-2 AI fine-tuned on 1,442 compliance examples.
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px; font-family: 'Georgia', serif; display: flex; align-items: center; gap: 8px;">
                                🎯 Quick Analysis Templates
                            </h3>
                                                    <div class="preset-buttons" style="max-height: 100px; overflow-x: auto; overflow-y: hidden; padding: 8px; border: 1px solid #e8d5c4; border-radius: 8px; background: rgba(255, 255, 255, 0.8);">
                            <div style="display: flex; gap: 8px; min-width: max-content;">
                    <button class="preset-btn" onclick="loadPreset('gdpr')">🇪🇺 GDPR Cookies</button>
                                <button class="preset-btn" onclick="loadPreset('ccpa')">🇺🇸 CCPA Rights</button>
                                <button class="preset-btn" onclick="loadPreset('kids')">👶 Age Verification</button>
                                <button class="preset-btn" onclick="loadPreset('targeting')">🎯 Ad Targeting</button>
                                <button class="preset-btn" onclick="loadPreset('transparency')">📊 Transparency</button>
                                <button class="preset-btn" onclick="loadPreset('breach')">🚨 Data Breach</button>
                                <button class="preset-btn" onclick="loadPreset('audit')">📋 Audit Trails</button>
                                <button class="preset-btn" onclick="loadPreset('rights')">⚖️ User Rights</button>
                                <button class="preset-btn" onclick="loadPreset('sharing')">🤝 Data Sharing</button>
                                <button class="preset-btn" onclick="loadPreset('moderation')">🛡️ Content Moderation</button>
                                <button class="preset-btn" onclick="loadPreset('notice')">📢 Notice & Action</button>
                                <button class="preset-btn" onclick="loadPreset('supervisory')">🏛️ Supervisory Authority</button>
                                <button class="preset-btn" onclick="loadPreset('simple')">⚡ Simple Feature</button>
                                <button class="preset-btn" onclick="loadPreset('biometric')">👁️ Biometric Data</button>
                                <button class="preset-btn" onclick="loadPreset('location')">📍 Location Services</button>
                                <button class="preset-btn" onclick="loadPreset('profiling')">🧠 Automated Profiling</button>
                                <button class="preset-btn" onclick="loadPreset('crossborder')">🌐 Cross-Border Transfer</button>
                                <button class="preset-btn" onclick="loadPreset('retention')">⏰ Data Retention</button>
                                <button class="preset-btn" onclick="loadPreset('consent')">✅ Consent Management</button>
                                <button class="preset-btn" onclick="loadPreset('portability')">📤 Data Portability</button>
                                <button class="preset-btn" onclick="loadPreset('deletion')">🗑️ Right to Deletion</button>
                                <button class="preset-btn" onclick="loadPreset('anonymization')">🕵️ Data Anonymization</button>
                                <button class="preset-btn" onclick="loadPreset('encryption')">🔐 Data Encryption</button>
                                <button class="preset-btn" onclick="loadPreset('monitoring')">📡 User Monitoring</button>
                            </div>
                        </div>
                </div>

                <form id="complianceForm">
                    <div class="form-group">
                                <label for="featureName">🏷️ Feature Name / Internal Codename</label>
                                <input type="text" id="featureName" placeholder="e.g., EU Cookie Consent Banner, LiveStreamGeoGate, UserDataExportTool" required>
                    </div>

                    <div class="form-group">
                                <label for="featureDescription">📝 Feature Description & Data Processing</label>
                                <textarea id="featureDescription" placeholder="Describe the feature, its functionality, data processing activities, and user interactions..." required></textarea>
                    </div>

                    <div class="form-group">
                                <label for="legalContext">⚖️ Known Legal Context (Optional)</label>
                                <textarea id="legalContext" placeholder='[{"law": "GDPR Article 7", "jurisdiction": "EU", "requirement": "Valid consent for data processing"}]'></textarea>
                                <div style="font-size: 0.85em; color: #7f8c8d; margin-top: 5px;">
                                    💡 Leave empty for automatic regulation detection, or provide known requirements in JSON format
                                </div>
                    </div>

                    <button type="submit" class="analyze-btn" id="analyzeBtn">
                                🔍 Screen for Geo-Compliance Requirements
                    </button>
                </form>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    Analyzing with Phi-2 v5...
                        </div>
                </div>
            </div>

                <!-- Right Panel: Output Section -->
                <div class="output-section" style="padding: 40px; background: rgba(255, 255, 255, 0.95); max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 25px; color: #2c3e50; font-family: 'Georgia', serif; font-size: 1.8em;">📊 Compliance Analysis Report</h2>
                
                <div id="results" class="result">
                    <!-- Results will be populated here -->
                </div>

                    <div id="placeholder" style="text-align: center; color: #7f8c8d; padding: 50px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">⚖️</div>
                        <div style="font-size: 1.4em; font-weight: 600; margin-bottom: 15px; color: #2c3e50; font-family: 'Georgia', serif;">TikTok Global Compliance Screening</div>
                        <p style="line-height: 1.6; color: #34495e; font-size: 1.1em; font-family: 'Georgia', serif;">Fill out the form on the left and click "🔍 Screen for Geo-Compliance Requirements" to begin your analysis.</p>
                        <div style="margin-top: 25px; font-size: 1em; color: #7f8c8d; font-family: 'Georgia', serif;">
                            <strong style="color: #d2691e;">Key Benefits:</strong><br>
                            🛡️ Proactive legal guardrails before feature launch<br>
                            📋 Auditable compliance evidence<br>
                            🌍 Automated regulatory traceability
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div style="background: linear-gradient(135deg, #d2691e, #cd853f); color: white; padding: 25px; border-radius: 12px; margin: 20px; text-align: center; box-shadow: 0 6px 20px rgba(210, 105, 30, 0.25); border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: center;">
                    <div style="text-align: left;">
                        <div style="font-size: 1.2em; font-weight: 700; margin-bottom: 5px; font-family: 'Georgia', serif; text-shadow: 0 1px 2px rgba(0,0,0,0.1);">🏆 TikTok TechJam 2025</div>
                        <div style="font-size: 0.9em; opacity: 0.95; font-family: 'Georgia', serif; font-style: italic;">Enterprise Compliance Analysis Platform</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 1em; font-weight: 600; margin-bottom: 5px; font-family: 'Georgia', serif;">👨‍💻 Developer</div>
                        <a href="https://www.linkedin.com/in/arnav-salkade-27076a201/" target="_blank" style="color: white; text-decoration: none; font-size: 0.9em; font-family: 'Georgia', serif; opacity: 0.95; transition: all 0.3s ease; padding: 5px 10px; border-radius: 6px; background: rgba(255,255,255,0.1);">
                            🔗 Arnav Salkade - LinkedIn
                        </a>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 1em; font-weight: 600; margin-bottom: 5px; font-family: 'Georgia', serif;">📚 GitHub</div>
                        <a href="https://github.com/Arnie016/Tiktok-TECHJAM" target="_blank" style="color: white; text-decoration: none; font-size: 0.9em; font-family: 'Georgia', serif; opacity: 0.95; transition: all 0.3s ease; padding: 5px 10px; border-radius: 6px; background: rgba(255,255,255,0.1);">
                            🔗 @Arnie016/Tiktok-TECHJAM
                        </a>
                    </div>
                </div>
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255, 255, 255, 0.2); font-size: 0.85em; opacity: 0.9; font-family: 'Georgia', serif; font-style: italic;">
                    🚀 From Guesswork to Governance: Automating Geo-Regulation with LLM Workshop
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chat Interface -->
    <div id="chatInterface" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; backdrop-filter: blur(5px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 800px; height: 80%; background: white; border-radius: 12px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); display: flex; flex-direction: column;">
            <!-- Chat Header -->
            <div style="background: linear-gradient(135deg, #d2691e, #cd853f); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: between; align-items: center;">
                <div>
                    <h3 style="margin: 0; font-size: 1.3em;">🤖 AI Compliance Assistant</h3>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">Chat about your compliance analysis results</p>
                </div>
                <button onclick="toggleChat()" style="background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 1.2em;">✕</button>
            </div>
            
            <!-- API Key Input -->
            <div id="apiKeySection" style="padding: 20px; border-bottom: 1px solid #e8d5c4; background: #fafafa;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="password" id="openaiApiKey" placeholder="Enter your OpenAI API key" style="flex: 1; padding: 10px; border: 1px solid #e8d5c4; border-radius: 6px; font-size: 0.9em;">
                    <button onclick="setApiKey()" style="background: #d2691e; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">Set Key</button>
                </div>
                <p style="margin: 5px 0 0 0; font-size: 0.8em; color: #666;">Your API key is stored locally and never sent to our servers</p>
            </div>
            
            <!-- Chat Messages -->
            <div id="chatMessages" style="flex: 1; padding: 20px; overflow-y: auto; background: #f9f9f9;">
                <div style="text-align: center; color: #666; font-style: italic;">
                    💬 Start chatting about your compliance analysis results...
                </div>
            </div>
            
            <!-- Chat Input -->
            <div style="padding: 20px; border-top: 1px solid #e8d5c4; background: white;">
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" placeholder="Ask about compliance requirements, implementation details, or legal implications..." style="flex: 1; padding: 12px; border: 1px solid #e8d5c4; border-radius: 6px; font-size: 0.9em;">
                    <button onclick="sendChatMessage()" style="background: #d2691e; color: white; border: none; padding: 12px 20px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Chat functionality - Initialize at top
        let chatContext = '';
        let openaiApiKey = '';

        // ✅ Updated with your working Lambda Function URL
        const LAMBDA_FUNCTION_URL = 'https://vcf7glhsl7w4yccfzny6tigqmm0znsxx.lambda-url.us-west-2.on.aws/';



        const presets = {
            gdpr: {
                name: "TikTok EU Cookie Consent System",
                description: "Cookie consent management system for EU users accessing TikTok web platform. Displays consent banner with granular options for analytics, advertising, and personalization cookies. Processes user consent choices and stores preferences.",
                context: '[{"law": "GDPR Article 7", "jurisdiction": "EU", "requirement": "Valid consent for data processing"}, {"law": "GDPR Article 6", "jurisdiction": "EU", "requirement": "Lawful basis for processing personal data"}]'
            },
            ccpa: {
                name: "TikTok California Privacy Rights Portal",
                description: "Privacy dashboard for California users providing options to opt-out of personal data sale, delete account data, and access personal information. Integrates with TikTok's data infrastructure to process user privacy requests.",
                context: '[{"law": "CCPA Section 1798.135", "jurisdiction": "US-CA", "requirement": "Right to opt-out of sale of personal information"}, {"law": "CCPA Section 1798.105", "jurisdiction": "US-CA", "requirement": "Right to delete personal information"}]'
            },
            kids: {
                name: "TikTok Global Age Verification & Parental Controls",
                description: "Multi-jurisdictional age verification system that detects user age through behavioral analysis and account signals. Implements different consent flows for users under 13 (US), under 16 (EU), and under 18 (some jurisdictions).",
                context: '[{"law": "COPPA", "jurisdiction": "US", "requirement": "Parental consent for children under 13"}, {"law": "GDPR Article 8", "jurisdiction": "EU", "requirement": "Parental consent for children under 16"}, {"law": "UK ICO Age Appropriate Design Code", "jurisdiction": "UK", "requirement": "Privacy by design for children"}]'
            },
            targeting: {
                name: "Targeted Advertising Consent Manager",
                description: "Consent management for targeted advertising with granular options for analytics and marketing purposes. Includes targeting criteria disclosure and delivery controls, particularly for vulnerable users like minors.",
                context: '[{"law": "CELEX 32022R2065", "jurisdiction": "EU", "requirement": "Targeting criteria disclosure for advertisements"}]'
            },
            transparency: {
                name: "Transparency Reporting Dashboard",
                description: "Dashboard for transparency reporting with automated content moderation statistics, user request handling metrics, and regulatory compliance reporting for multiple jurisdictions.",
                context: '[{"law": "Utah Social Media Regulation", "jurisdiction": "US-UT", "requirement": "Social media transparency reporting"}]'
            },
            breach: {
                name: "Data Breach Notification System",
                description: "Automated system for data breach detection, assessment, and notification to relevant authorities and affected users across different jurisdictions with varying notification timelines.",
                context: '[{"law": "GDPR Article 33", "jurisdiction": "EU", "requirement": "72-hour breach notification"}, {"law": "CCPA Section 1798.82", "jurisdiction": "US-CA", "requirement": "California breach notification law"}]'
            },
            audit: {
                name: "Audit Trail & Logging System",
                description: "Comprehensive audit logging system that tracks user actions, data access, and system changes with configurable retention periods and access controls for regulatory compliance.",
                context: '[{"law": "GDPR Article 30", "jurisdiction": "EU", "requirement": "Records of processing activities"}, {"law": "SOX Section 404", "jurisdiction": "US", "requirement": "Internal controls documentation"}]'
            },
            rights: {
                name: "User Rights Management Portal",
                description: "Centralized portal for users to exercise their data protection rights including access, rectification, erasure, and portability with automated request processing and verification.",
                context: '[{"law": "GDPR Chapter 3", "jurisdiction": "EU", "requirement": "Data subject rights"}, {"law": "CCPA Section 1798.100", "jurisdiction": "US-CA", "requirement": "Consumer rights"}]'
            },
            sharing: {
                name: "Third-Party Data Sharing Controls",
                description: "Controls for third-party data sharing with consent management, partner verification, and data processing agreement enforcement across different jurisdictions.",
                context: '[{"law": "GDPR Article 28", "jurisdiction": "EU", "requirement": "Data processing agreements"}, {"law": "PIPEDA", "jurisdiction": "CA", "requirement": "Third-party disclosure requirements"}]'
            },
            moderation: {
                name: "Content Moderation Engine",
                description: "Automated content moderation system that analyzes user-generated content for policy violations, illegal content, and harmful material using AI algorithms and human review workflows.",
                context: '[{"law": "CELEX 32022R2065", "jurisdiction": "EU", "requirement": "Content moderation reporting requirements"}, {"law": "Section 230", "jurisdiction": "US", "requirement": "Platform liability protections"}]'
            },
            notice: {
                name: "Notice-and-Action Portal",
                description: "Portal for users to report illegal content and for platforms to take action on reported content with transparency mechanisms and appeal processes.",
                context: '[{"law": "CELEX 32022R2065", "jurisdiction": "EU", "requirement": "Notice and action mechanisms"}, {"law": "Florida Online Protections", "jurisdiction": "US-FL", "requirement": "Content reporting requirements"}]'
            },
            supervisory: {
                name: "Supervisory Authority Communication",
                description: "System for communicating with regulatory authorities, submitting compliance reports, and responding to supervisory inquiries across multiple jurisdictions.",
                context: '[{"law": "CELEX 32022R2065", "jurisdiction": "EU", "requirement": "Supervisory authority cooperation"}, {"law": "California Privacy Rights Act", "jurisdiction": "US-CA", "requirement": "CPPA enforcement"}]'
            },
            simple: {
                name: "TikTok Dark Mode Theme Toggle",
                description: "Simple UI preference toggle that allows users to switch between light and dark visual themes. Stores preference locally in browser settings without server-side data processing.",
                context: '[]'
            },
            biometric: {
                name: "TikTok Biometric Authentication System",
                description: "Biometric authentication system using facial recognition and fingerprint scanning for user login and content verification. Processes biometric data for identity verification and fraud prevention.",
                context: '[{"law": "GDPR Article 9", "jurisdiction": "EU", "requirement": "Special category data processing"}, {"law": "BIPA", "jurisdiction": "US-IL", "requirement": "Biometric information privacy"}]'
            },
            location: {
                name: "TikTok Location-Based Content Delivery",
                description: "Location-based content recommendation system that uses GPS data to suggest local trends, nearby events, and region-specific content. Processes location data for personalized content delivery.",
                context: '[{"law": "GDPR Article 6", "jurisdiction": "EU", "requirement": "Lawful basis for location processing"}, {"law": "CCPA Section 1798.140", "jurisdiction": "US-CA", "requirement": "Personal information definition"}]'
            },
            profiling: {
                name: "TikTok Automated User Profiling System",
                description: "Automated system that creates user profiles based on behavior analysis, content preferences, and interaction patterns. Uses AI algorithms to categorize users for content recommendations.",
                context: '[{"law": "GDPR Article 22", "jurisdiction": "EU", "requirement": "Automated decision-making rights"}, {"law": "CCPA Section 1798.185", "jurisdiction": "US-CA", "requirement": "Profiling regulations"}]'
            },
            crossborder: {
                name: "TikTok Cross-Border Data Transfer System",
                description: "System for transferring user data across international borders for content delivery and analytics. Implements data transfer mechanisms between EU, US, and other global regions.",
                context: '[{"law": "GDPR Chapter 5", "jurisdiction": "EU", "requirement": "Cross-border data transfers"}, {"law": "Schrems II", "jurisdiction": "EU", "requirement": "Adequacy decisions"}]'
            },
            retention: {
                name: "TikTok Data Retention Management System",
                description: "Automated data retention system that manages user data lifecycle, deletion schedules, and archival processes. Implements different retention periods based on data type and jurisdiction.",
                context: '[{"law": "GDPR Article 5", "jurisdiction": "EU", "requirement": "Storage limitation principle"}, {"law": "CCPA Section 1798.105", "jurisdiction": "US-CA", "requirement": "Right to deletion"}]'
            },
            consent: {
                name: "TikTok Granular Consent Management Platform",
                description: "Comprehensive consent management platform that handles different types of consent for data processing, marketing, and third-party sharing. Provides granular control options for users.",
                context: '[{"law": "GDPR Article 7", "jurisdiction": "EU", "requirement": "Conditions for consent"}, {"law": "CCPA Section 1798.120", "jurisdiction": "US-CA", "requirement": "Opt-out rights"}]'
            },
            portability: {
                name: "TikTok Data Portability Export System",
                description: "System that allows users to export their personal data in machine-readable formats. Enables data transfer to other platforms and services as required by data protection regulations.",
                context: '[{"law": "GDPR Article 20", "jurisdiction": "EU", "requirement": "Right to data portability"}, {"law": "CCPA Section 1798.130", "jurisdiction": "US-CA", "requirement": "Data disclosure requirements"}]'
            },
            deletion: {
                name: "TikTok Right to Deletion Portal",
                description: "Portal for users to request complete deletion of their personal data from TikTok systems. Implements automated deletion workflows and verification processes.",
                context: '[{"law": "GDPR Article 17", "jurisdiction": "EU", "requirement": "Right to erasure"}, {"law": "CCPA Section 1798.105", "jurisdiction": "US-CA", "requirement": "Right to deletion"}]'
            },
            anonymization: {
                name: "TikTok Data Anonymization Engine",
                description: "Automated system that anonymizes user data for analytics and research purposes. Implements privacy-preserving techniques while maintaining data utility for business insights.",
                context: '[{"law": "GDPR Article 25", "jurisdiction": "EU", "requirement": "Data protection by design"}, {"law": "CCPA Section 1798.140", "jurisdiction": "US-CA", "requirement": "Deidentified information"}]'
            },
            encryption: {
                name: "TikTok Data Encryption & Security System",
                description: "End-to-end encryption system for user communications and data storage. Implements encryption standards for data at rest and in transit across all jurisdictions.",
                context: '[{"law": "GDPR Article 32", "jurisdiction": "EU", "requirement": "Security of processing"}, {"law": "CCPA Section 1798.150", "jurisdiction": "US-CA", "requirement": "Security requirements"}]'
            },
            monitoring: {
                name: "TikTok User Behavior Monitoring System",
                description: "System that monitors user behavior for security, fraud detection, and content moderation. Tracks user interactions, patterns, and suspicious activities.",
                context: '[{"law": "GDPR Article 6", "jurisdiction": "EU", "requirement": "Legitimate interest processing"}, {"law": "CCPA Section 1798.140", "jurisdiction": "US-CA", "requirement": "Personal information monitoring"}]'
            }
        };

        function loadPreset(type) {
            const preset = presets[type];
            if (preset) {
                const featureNameElement = document.getElementById('featureName');
                const featureDescriptionElement = document.getElementById('featureDescription');
                const lawContextElement = document.getElementById('legalContext');
                
                if (featureNameElement) featureNameElement.value = preset.name;
                if (featureDescriptionElement) featureDescriptionElement.value = preset.description;
                if (lawContextElement) lawContextElement.value = preset.context;
            }
        }

        function openDatasetExplorer() {
            const datasetContent = `
                <div style="background: rgba(255, 255, 255, 0.98); padding: 30px; border-radius: 12px; border: 2px solid #d2691e; box-shadow: 0 8px 30px rgba(210, 105, 30, 0.2); max-width: 900px; margin: 20px auto; font-family: 'Georgia', serif;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <div>
                            <h2 style="color: #2c3e50; font-weight: 600; letter-spacing: 1px; margin-bottom: 5px;">🧠 Training Dataset Explorer</h2>
                            <p style="color: #7f8c8d; font-style: italic; margin: 0;">Microsoft Phi-2 v5 Fine-tuning Analysis</p>
                        </div>
                        <button onclick="closeDatasetExplorer()" style="background: #d2691e; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-family: 'Georgia', serif; font-weight: 600; cursor: pointer; font-size: 0.9em;">
                            ✕ Close
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
                        <!-- Left Column -->
                        <div>
                            <div style="background: linear-gradient(135deg, #ffe8d6, #ffdab9); padding: 20px; border-radius: 8px; border-left: 4px solid #d2691e; margin-bottom: 20px;">
                                <h3 style="color: #2c3e50; margin-bottom: 12px; font-size: 1.1em;">🎯 Training Overview</h3>
                                <div style="font-size: 0.9em; color: #34495e; line-height: 1.5;">
                                    <strong>Model:</strong> Microsoft Phi-2 v5<br>
                                    <strong>Examples:</strong> 1,442 compliance pairs<br>
                                    <strong>Jurisdictions:</strong> 15+ global regions<br>
                                    <strong>Laws:</strong> 25+ regulations covered
                                </div>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #fff5f0, #ffe8d6); padding: 20px; border-radius: 8px; border-left: 4px solid #cd853f; margin-bottom: 20px;">
                                <h3 style="color: #2c3e50; margin-bottom: 12px; font-size: 1.1em;">📊 Dataset Stats</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.85em; color: #34495e;">
                                    <div><strong>Total:</strong> 1,442</div>
                                    <div><strong>EU Examples:</strong> 487</div>
                                    <div><strong>US Examples:</strong> 356</div>
                                    <div><strong>Global:</strong> 599</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div>
                            <div style="background: linear-gradient(135deg, #fff8dc, #fffacd); padding: 20px; border-radius: 8px; border-left: 4px solid #daa520;">
                                <h3 style="color: #2c3e50; margin-bottom: 12px; font-size: 1.1em;">💡 Sample Examples</h3>
                                <div style="font-size: 0.85em; color: #34495e; line-height: 1.4;">
                                    <div style="margin-bottom: 12px; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                        <strong>GDPR Cookies:</strong> EU consent banner → "Needs Geo-Compliance"
                                    </div>
                                    <div style="margin-bottom: 12px; padding: 8px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                        <strong>CCPA Rights:</strong> CA privacy portal → "Needs Geo-Compliance"
                                    </div>
                                    <div style="padding: 8px; background: rgba(255,255,255,0.7); border-radius: 4px;">
                                        <strong>Age Verification:</strong> Global age check → "Multi-jurisdictional"
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e8d5c4;">
                        <div style="font-size: 0.9em; color: #7f8c8d; font-style: italic;">
                            Fine-tuned for accurate geo-compliance detection across global jurisdictions
                        </div>
                    </div>
                </div>
            `;
            
            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'datasetOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            overlay.innerHTML = datasetContent;
            document.body.appendChild(overlay);
        }

        function closeDatasetExplorer() {
            const overlay = document.getElementById('datasetOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        function exportComplianceReport() {
            const reportId = `RPT-${Date.now().toString().slice(-6)}`;
            const timestamp = new Date().toISOString();
            const featureNameElement = document.getElementById('featureName');
            const featureDescriptionElement = document.getElementById('featureDescription');
            
            // Check if elements exist before accessing their values
            const featureName = featureNameElement ? featureNameElement.value : 'Not available';
            const featureDescription = featureDescriptionElement ? featureDescriptionElement.value : 'Not available';
            
            // Get current analysis data
            const resultsDiv = document.getElementById('results');
            if (!resultsDiv.innerHTML.includes('COMPLIANCE ANALYSIS REPORT')) {
                alert('Please run a compliance analysis first.');
                return;
            }

            // Extract analysis data from the current display
            const analysis = window.currentAnalysis || {};
            
            // Create CSV content
            const csvContent = [
                // Header
                ['COMPLIANCE ANALYSIS REPORT - EXPORT'],
                ['Generated:', timestamp],
                ['Report ID:', reportId],
                [''],
                
                // Feature Information
                ['FEATURE INFORMATION'],
                ['Feature Name:', featureName],
                ['Feature Description:', featureDescription],
                [''],
                
                // Compliance Assessment
                ['COMPLIANCE ASSESSMENT'],
                ['Geo-Compliance Required:', analysis.hasGeoCompliance ? 'YES' : 'NO'],
                ['Compliance Score:', `${analysis.complianceScore || 85}%`],
                ['Risk Level:', (analysis.riskLevel || 'medium').toUpperCase()],
                [''],
                
                // Executive Summary
                ['EXECUTIVE SUMMARY'],
                ['Summary:', analysis.summary || 'No summary available'],
                [''],
                
                // Affected Jurisdictions
                ['AFFECTED JURISDICTIONS'],
                ['Code', 'Name', 'Flag', 'Color'],
                ...(analysis.jurisdictions || []).map(j => [j.code, j.name, j.flag, j.color]),
                [''],
                
                // Legal Requirements
                ['LEGAL REQUIREMENTS'],
                ['Law Code', 'Full Name', 'Article', 'Description', 'Color'],
                ...(analysis.laws || []).map(law => [
                    law.name, 
                    law.fullName, 
                    law.article || 'N/A', 
                    law.description, 
                    law.color
                ]),
                [''],
                
                // Implementation Requirements
                ['IMPLEMENTATION REQUIREMENTS'],
                ['Task Number', 'Requirement', 'Priority', 'Estimated Effort'],
                ...(analysis.requirements || []).map((req, index) => {
                    const priority = index === 0 ? 'Critical' : index === 1 ? 'High' : 'Medium';
                    const effort = index === 0 ? '2-3 sprints' : index === 1 ? '1-2 sprints' : '1 sprint';
                    return [`Task ${index + 1}`, req, priority, effort];
                }),
                [''],
                
                // Model Information
                ['MODEL INFORMATION'],
                ['AI Model:', 'Microsoft Phi-2 v5'],
                ['Training Dataset:', '1,442 compliance examples'],
                ['Specialization:', 'Geo-Compliance Analysis'],
                ['Processing Length:', `${window.currentMetadata?.response_length || 0} characters`],
                [''],
                
                // Audit Information
                ['AUDIT INFORMATION'],
                ['Analysis Timestamp:', timestamp],
                ['Platform:', 'TikTok Enterprise Compliance Platform'],
                ['AI Provider:', 'Microsoft Phi-2 LLM'],
                ['Infrastructure:', 'AWS SageMaker'],
                ['Export Generated:', new Date().toISOString()]
            ];

            // Convert to CSV string
            const csvString = csvContent.map(row => 
                row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            // Download file
            downloadCSV(csvString, `compliance_report_${reportId}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function exportAuditTrail() {
            const reportId = `RPT-${Date.now().toString().slice(-6)}`;
            const timestamp = new Date().toISOString();
            const featureNameElement = document.getElementById('featureName');
            const featureDescriptionElement = document.getElementById('featureDescription');
            const lawContextElement = document.getElementById('legalContext');
            
            // Check if elements exist before accessing their values
            const featureName = featureNameElement ? featureNameElement.value : 'Not available';
            const featureDescription = featureDescriptionElement ? featureDescriptionElement.value : 'Not available';
            const lawContext = lawContextElement ? lawContextElement.value : 'Not available';
            
            // Create comprehensive audit trail
            const auditTrail = [
                // Header
                ['AUDIT TRAIL - COMPLIANCE ANALYSIS'],
                ['Generated:', timestamp],
                ['Report ID:', reportId],
                [''],
                
                // Analysis Session
                ['ANALYSIS SESSION'],
                ['Session Start:', timestamp],
                ['Feature Analyzed:', featureName],
                ['Analysis Type:', 'Geo-Compliance Assessment'],
                ['AI Model Used:', 'Microsoft Phi-2 v5'],
                ['Training Dataset Size:', '1,442 examples'],
                [''],
                
                // Input Data
                ['INPUT DATA'],
                ['Feature Name:', featureName],
                ['Feature Description:', featureDescription],
                ['Law Context:', lawContext],
                [''],
                
                // Processing Details
                ['PROCESSING DETAILS'],
                ['Model Endpoint:', 'phi2-v5-inference'],
                ['Processing Time:', `${window.currentMetadata?.response_length || 0} characters processed`],
                ['Analysis Method:', 'Fine-tuned LLM with geo-compliance specialization'],
                [''],
                
                // Output Analysis
                ['OUTPUT ANALYSIS'],
                ['Raw Model Response:', window.currentRawResponse || 'Not available'],
                ['Parsed Compliance Flag:', window.currentAnalysis?.hasGeoCompliance ? 'YES' : 'NO'],
                ['Compliance Score:', `${window.currentAnalysis?.complianceScore || 85}%`],
                ['Risk Assessment:', (window.currentAnalysis?.riskLevel || 'medium').toUpperCase()],
                [''],
                
                // Jurisdictions Identified
                ['JURISDICTIONS IDENTIFIED'],
                ['Jurisdiction Code', 'Jurisdiction Name', 'Detection Method'],
                ...(window.currentAnalysis?.jurisdictions || []).map(j => [j.code, j.name, 'AI Analysis']),
                [''],
                
                // Laws Referenced
                ['LAWS REFERENCED'],
                ['Law Code', 'Full Name', 'Article', 'Relevance Score'],
                ...(window.currentAnalysis?.laws || []).map(law => [
                    law.name, 
                    law.fullName, 
                    law.article || 'N/A', 
                    'High'
                ]),
                [''],
                
                // Implementation Actions
                ['IMPLEMENTATION ACTIONS'],
                ['Action ID', 'Description', 'Priority', 'Effort Estimate', 'Compliance Impact'],
                ...(window.currentAnalysis?.requirements || []).map((req, index) => {
                    const priority = index === 0 ? 'Critical' : index === 1 ? 'High' : 'Medium';
                    const effort = index === 0 ? '2-3 sprints' : index === 1 ? '1-2 sprints' : '1 sprint';
                    const impact = index === 0 ? 'High' : index === 1 ? 'Medium' : 'Low';
                    return [`ACT-${index + 1}`, req, priority, effort, impact];
                }),
                [''],
                
                // Technical Metadata
                ['TECHNICAL METADATA'],
                ['Model Version:', 'Phi-2 v5'],
                ['Training Examples:', '1,442'],
                ['Specialization:', 'Geo-Compliance Analysis'],
                ['Processing Framework:', 'AWS SageMaker'],
                ['Response Format:', 'JSON'],
                [''],
                
                // Audit Trail
                ['AUDIT TRAIL'],
                ['Event', 'Timestamp', 'Details'],
                ['Analysis Requested', timestamp, `Feature: ${featureName}`],
                ['Model Invoked', timestamp, 'Microsoft Phi-2 v5'],
                ['Response Generated', timestamp, 'Compliance assessment completed'],
                ['Results Parsed', timestamp, 'Structured data extracted'],
                ['Report Generated', timestamp, 'Compliance report created'],
                ['Export Created', new Date().toISOString(), 'Audit trail exported'],
                [''],
                
                // Compliance Framework
                ['COMPLIANCE FRAMEWORK'],
                ['Framework Type:', 'Multi-Jurisdictional Privacy Law Analysis'],
                ['Coverage:', 'GDPR, CCPA, LGPD, PIPEDA, and 20+ other regulations'],
                ['Analysis Depth:', 'Feature-level compliance assessment'],
                ['Risk Assessment:', 'Automated risk level calculation'],
                [''],
                
                // Export Information
                ['EXPORT INFORMATION'],
                ['Export Type:', 'Audit Trail CSV'],
                ['Export Timestamp:', new Date().toISOString()],
                ['Export Purpose:', 'Compliance Documentation'],
                ['Data Retention:', 'Audit-ready format for regulatory review'],
                ['Generated By:', 'TikTok Enterprise Compliance Platform'],
                ['AI Model:', 'Microsoft Phi-2 v5 Fine-tuned']
            ];

            // Convert to CSV string
            const csvString = auditTrail.map(row => 
                row.map(cell => `"${(cell || '').toString().replace(/"/g, '""')}"`).join(',')
            ).join('\n');

            // Download file
            downloadCSV(csvString, `audit_trail_${reportId}_${new Date().toISOString().split('T')[0]}.csv`);
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Add event listener only when the form exists
        const complianceForm = document.getElementById('complianceForm');
        if (complianceForm) {
            complianceForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
                const featureNameElement = document.getElementById('featureName');
                const featureDescriptionElement = document.getElementById('featureDescription');
                const lawContextElement = document.getElementById('legalContext');
                
                // Check if elements exist before accessing their values
                if (!featureNameElement || !featureDescriptionElement || !lawContextElement) {
                    showError('Form elements not found. Please ensure the analysis tool is loaded.');
                    return;
                }
                
                const featureName = featureNameElement.value;
                const featureDescription = featureDescriptionElement.value;
                const lawContext = lawContextElement.value;

            if (!LAMBDA_FUNCTION_URL || LAMBDA_FUNCTION_URL === 'YOUR_LAMBDA_FUNCTION_URL_HERE') {
                showError('Please update the LAMBDA_FUNCTION_URL in the JavaScript code with your actual Lambda Function URL.');
                return;
            }

            // Show loading
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('placeholder').style.display = 'none';

            try {
                const payload = {
                    instruction: "Analyse the feature artifact and decide if geo-specific compliance logic is needed. Explain why and cite the relevant regulation if any.",
                    input: `Feature Name: ${featureName}\nFeature Description: ${featureDescription}\n\nLaw Context (structured JSON):\n${lawContext}`
                };

                const response = await fetch(LAMBDA_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                displayResults(result);

            } catch (error) {
                console.error('Error:', error);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('loading').style.display = 'none';
            }
        });
        }

        function displayResults(result) {
            const resultsDiv = document.getElementById('results');
            
            if (!result.success) {
                showError('Analysis failed: ' + (result.error?.message || 'Unknown error'));
                return;
            }

            // Use structured compliance data from Lambda response
            const compliance = result.compliance || {};
            const metadata = result.metadata || {};
            const rawResponse = result.raw_response || '';
            
            // Debug logging
            console.log('Raw response:', rawResponse);
            console.log('Compliance:', compliance);
            
            // Convert structured compliance data to the format expected by the UI
            const analysis = convertComplianceToAnalysis(compliance, rawResponse);
            
            // Debug logging
            console.log('Analysis summary:', analysis.summary);
            
            // Store analysis data globally for export functions
            window.currentAnalysis = analysis;
            window.currentMetadata = metadata;
            window.currentRawResponse = JSON.stringify(compliance, null, 2);
            
            // Update chat context with new analysis
            if (typeof updateChatContext === 'function') {
                updateChatContext();
            }
            
            resultsDiv.innerHTML = `
                <!-- Legal Document Header -->
                <div style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 10px; margin-bottom: 30px; border: 2px solid #d2691e; box-shadow: 0 4px 15px rgba(210, 105, 30, 0.1);">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start;">
                        <div>
                            <div style="font-size: 2.2em; font-weight: 600; color: #2c3e50; margin-bottom: 15px; font-family: 'Georgia', serif; letter-spacing: 0.5px;">
                                COMPLIANCE ANALYSIS REPORT
                            </div>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <div style="background: ${analysis.hasGeoCompliance ? '#d2691e' : '#27ae60'}; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; font-weight: 600; font-family: 'Georgia', serif;">
                                    ${analysis.hasGeoCompliance ? 'GEO-SPECIFIC COMPLIANCE REQUIRED' : 'STANDARD IMPLEMENTATION SUFFICIENT'}
                                </div>
                                <div style="background: #cd853f; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; font-weight: 600; font-family: 'Georgia', serif;">
                                    COMPLIANCE SCORE: ${analysis.complianceScore}%
                                </div>
                                <div style="background: #daa520; color: white; padding: 8px 12px; border-radius: 5px; font-size: 0.9em; font-weight: 600; font-family: 'Georgia', serif;">
                                    RISK LEVEL: ${analysis.riskLevel.toUpperCase()}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right; background: #ecf0f1; padding: 12px; border-radius: 3px; border: 1px solid #bdc3c7;">
                            <div style="font-size: 0.75em; color: #7f8c8d; margin-bottom: 3px; font-family: 'Times New Roman', serif;">REPORT ID</div>
                            <div style="font-size: 0.9em; font-weight: bold; color: #2c3e50; margin-bottom: 5px; font-family: 'Times New Roman', serif;">RPT-${Date.now().toString().slice(-6)}</div>
                            <div style="font-size: 0.75em; color: #7f8c8d; font-family: 'Times New Roman', serif;">${new Date().toLocaleString()}</div>
                        </div>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div style="background: linear-gradient(135deg, #ffe8d6, #ffdab9); padding: 30px; border-radius: 10px; border: 2px solid #cd853f; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(205, 133, 63, 0.15);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-weight: 600; color: #2c3e50; font-family: 'Georgia', serif; font-size: 1.4em;">
                        <span style="font-size: 1.5em;">📋</span>
                        <span>EXECUTIVE SUMMARY</span>
                    </div>
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 20px; font-family: 'Georgia', serif; font-size: 1.3em;">
                        ${analysis.hasGeoCompliance ? 'GEO-SPECIFIC REQUIREMENTS DETECTED' : 'STANDARD IMPLEMENTATION SUFFICIENT'}
                    </div>
                    <div style="color: #34495e; font-family: 'Georgia', serif; font-size: 1.1em; line-height: 1.7; white-space: pre-line;">
                        ${analysis.summary.replace(/https?:\/\/[^\s]+/g, '')}
                    </div>
                </div>

                ${analysis.jurisdictions.length > 0 ? `
                <div style="background: linear-gradient(135deg, #ffe8d6, #ffdab9); padding: 30px; border-radius: 10px; border: 2px solid #cd853f; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(205, 133, 63, 0.15);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-weight: 600; color: #2c3e50; font-family: 'Georgia', serif; font-size: 1.4em;">
                        <span style="font-size: 1.5em;">🌍</span>
                        <span>Affected Jurisdictions</span>
                        <span style="background: rgba(210, 105, 30, 0.2); color: #d2691e; padding: 3px 10px; border-radius: 10px; font-size: 0.75em; font-weight: normal;">${analysis.jurisdictions.length}</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                        ${analysis.jurisdictions.map(j => `
                            <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9)); border: 2px solid ${j.color}; padding: 15px; border-radius: 10px; text-align: center; min-width: 140px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                                <div style="font-size: 2em; margin-bottom: 8px;">${j.flag}</div>
                                <div style="font-weight: 600; color: ${j.color}; font-size: 1.1em; font-family: 'Georgia', serif;">${j.code}</div>
                                <div style="font-size: 0.9em; color: #2c3e50; font-family: 'Georgia', serif;">${j.name}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${analysis.laws.length > 0 ? `
                <div style="background: linear-gradient(135deg, #ffe8d6, #ffdab9); padding: 30px; border-radius: 10px; border: 2px solid #cd853f; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(205, 133, 63, 0.15);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-weight: 600; color: #2c3e50; font-family: 'Georgia', serif; font-size: 1.4em;">
                        <span style="font-size: 1.5em;">⚖️</span>
                        <span>Legal Requirements</span>
                        <span style="background: rgba(210, 105, 30, 0.2); color: #d2691e; padding: 3px 10px; border-radius: 10px; font-size: 0.75em; font-weight: normal;">${analysis.laws.length}</span>
                    </div>
                    <div style="display: grid; gap: 15px;">
                        ${analysis.laws.map(law => {
                            const jurisdictionMap = {
                                'EU': { flag: '🇪🇺', name: 'European Union', color: '#d2691e' },
                                'US-CA': { flag: '🇺🇸', name: 'California', color: '#cd853f' },
                                'CA': { flag: '🇨🇦', name: 'Canada', color: '#daa520' },
                                'BR': { flag: '🇧🇷', name: 'Brazil', color: '#daa520' },
                                'UK': { flag: '🇬🇧', name: 'United Kingdom', color: '#d2691e' }
                            };
                            const jurisdiction = jurisdictionMap[law.jurisdiction] || { flag: '🌍', name: law.jurisdiction, color: law.color };
                            
                            return `
                            <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9)); border: 2px solid ${jurisdiction.color}; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 12px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 2em;">${jurisdiction.flag}</span>
                                        <div>
                                            <div style="font-weight: bold; color: ${jurisdiction.color}; font-size: 1.1em; font-family: 'Georgia', serif;">${jurisdiction.name}</div>
                                            <div style="font-size: 0.9em; color: #7f8c8d; font-family: 'Georgia', serif;">${law.jurisdiction}</div>
                                        </div>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; color: ${law.color}; font-size: 1.2em; font-family: 'Georgia', serif;">${law.name}${law.article ? ` Article ${law.article}` : ''}</div>
                                        <div style="font-size: 0.9em; color: #7f8c8d; font-family: 'Georgia', serif;">${law.fullName}</div>
                                    </div>
                                </div>
                                <div style="color: #2c3e50; font-size: 1em; line-height: 1.5; font-family: 'Georgia', serif; background: rgba(210, 105, 30, 0.05); padding: 12px; border-radius: 6px; border-left: 3px solid ${jurisdiction.color};">
                                    ${law.description}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
                ` : ''}

                ${analysis.requirements.length > 0 ? `
                <div style="background: linear-gradient(135deg, #ffe8d6, #ffdab9); padding: 30px; border-radius: 10px; border: 2px solid #cd853f; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(205, 133, 63, 0.15);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-weight: 600; color: #2c3e50; font-family: 'Georgia', serif; font-size: 1.4em;">
                        <span style="font-size: 1.5em;">⚡</span>
                        <span>Implementation Action Items</span>
                        <span style="background: rgba(210, 105, 30, 0.2); color: #d2691e; padding: 3px 10px; border-radius: 10px; font-size: 0.75em; font-weight: normal;">${analysis.requirements.length}</span>
                    </div>
                    <div style="font-size: 1em; color: #7f8c8d; margin-bottom: 15px; padding: 12px; background: rgba(218, 165, 32, 0.1); border-radius: 6px; border-left: 3px solid #daa520; font-family: 'Georgia', serif;">
                        💡 <strong>Engineering Guidance:</strong> Prioritized implementation tasks
                    </div>
                    <div style="display: grid; gap: 15px;">
                        ${analysis.requirements.map((req, index) => {
                            const priority = index === 0 ? 'Critical' : index === 1 ? 'High' : 'Medium';
                            const effort = index === 0 ? '2-3 sprints' : index === 1 ? '1-2 sprints' : '1 sprint';
                            const priorityColor = index === 0 ? '#d2691e' : index === 1 ? '#cd853f' : '#daa520';
                            return `
                            <div style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9)); border: 2px solid #e8d5c4; padding: 15px; border-radius: 10px; border-left: 4px solid ${priorityColor}; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
                                <div style="display: flex; align-items: start; gap: 15px;">
                                    <div style="background: ${priorityColor}; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9em; flex-shrink: 0; margin-top: 1px;">${index + 1}</div>
                                    <div style="flex: 1;">
                                        <div style="color: #2c3e50; font-size: 1.1em; line-height: 1.7; margin-bottom: 12px; font-family: 'Georgia', serif; font-weight: 500;">
                                            <strong style="color: #d2691e; font-size: 1.1em;">Task ${index + 1}:</strong> ${req.charAt(0).toUpperCase() + req.slice(1).slice(0, 150)}${req.length > 150 ? '...' : ''}
                                        </div>
                                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                            <div style="background: rgba(${priorityColor.replace('#', '').match(/.{2}/g).map(x => parseInt(x, 16)).join(', ')}, 0.2); color: ${priorityColor}; padding: 6px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600;">
                                                ${priority}
                                            </div>
                                            <div style="background: rgba(210, 105, 30, 0.2); color: #d2691e; padding: 6px 10px; border-radius: 12px; font-size: 0.8em;">
                                                ${effort}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
                ` : ''}

                <div style="background: linear-gradient(135deg, #ffe8d6, #ffdab9); padding: 30px; border-radius: 10px; border: 2px solid #cd853f; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(205, 133, 63, 0.15);">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-weight: 600; color: #2c3e50; font-family: 'Georgia', serif; font-size: 1.4em;">
                        <span style="font-size: 1.5em;">🧠</span>
                        <span>Microsoft Phi-2 Model Details</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                        <div>
                            <div style="font-size: 0.75em; color: #7f8c8d; margin-bottom: 4px; font-family: 'Georgia', serif;">AI Model</div>
                            <div style="font-size: 1em; font-weight: bold; color: #d2691e; font-family: 'Georgia', serif;">Microsoft Phi-2 v5</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75em; color: #7f8c8d; margin-bottom: 4px; font-family: 'Georgia', serif;">Training Dataset</div>
                            <div style="font-size: 1em; font-weight: bold; color: #d2691e; font-family: 'Georgia', serif;">1,442 compliance pairs</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75em; color: #7f8c8d; margin-bottom: 4px; font-family: 'Georgia', serif;">Specialization</div>
                            <div style="font-size: 1em; font-weight: bold; color: #d2691e; font-family: 'Georgia', serif;">Geo-Compliance Analysis</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75em; color: #7f8c8d; margin-bottom: 4px; font-family: 'Georgia', serif;">Processing</div>
                            <div style="font-size: 1em; font-weight: bold; color: #d2691e; font-family: 'Georgia', serif;">${metadata.response_length || 0} chars</div>
                        </div>
                    </div>
                </div>

                ${result.analysis?.raw_response ? `
                <div class="section">
                    <h3 style="color: #2c3e50; font-family: 'Georgia', serif; font-size: 1.2em;">🔍 Technical Details</h3>
                    <details style="background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; border: 1px solid #e8d5c4; box-shadow: 0 2px 8px rgba(210, 105, 30, 0.1);">
                        <summary style="cursor: pointer; font-weight: bold; margin-bottom: 10px; color: #2c3e50; font-family: 'Georgia', serif;">View Raw Model Response</summary>
                        <pre style="background: rgba(248, 249, 250, 0.95); color: #2c3e50; padding: 10px; border-radius: 4px; font-size: 0.85em; overflow-x: auto; white-space: pre-wrap; border: 1px solid #e8d5c4; font-family: 'Georgia', serif;">${JSON.stringify(result.analysis.raw_response, null, 2)}</pre>
                    </details>
                </div>
                ` : ''}

                <div style="background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; margin-top: 20px; border: 1px solid #e8d5c4; box-shadow: 0 2px 8px rgba(210, 105, 30, 0.1);">
                    <details>
                        <summary style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: 600; color: #2c3e50; font-family: 'Georgia', serif;">
                            <span>📊 Audit Trail & Metadata</span>
                            <span style="font-size: 0.8em; color: #7f8c8d;">For Documentation</span>
                        </summary>
                        <div style="margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; font-size: 0.8em; color: #2c3e50; font-family: 'Georgia', serif;">
                                <div>
                                    <strong style="color: #d2691e;">Model:</strong> Microsoft Phi-2 v5<br>
                                    <strong style="color: #d2691e;">Dataset:</strong> 1,442 compliance examples<br>
                                    <strong style="color: #d2691e;">Framework:</strong> Multi-jurisdictional analysis
                    </div>
                                <div>
                                    <strong style="color: #d2691e;">Timestamp:</strong> ${new Date().toLocaleString()}<br>
                                    <strong style="color: #d2691e;">Processing:</strong> ${metadata.response_length || 0} chars<br>
                                    <strong style="color: #d2691e;">Endpoint:</strong> AWS SageMaker
                </div>
                </div>
                            <div style="text-align: center; margin-top: 12px; font-size: 0.75em; color: #7f8c8d; border-top: 1px solid #e8d5c4; padding-top: 8px; font-family: 'Georgia', serif;">
                                🏢 TikTok Enterprise Compliance Platform • Microsoft Phi-2 LLM • Audit-ready Documentation
                            </div>
                        </div>
                    </details>
                </div>


                </div>
                    </details>
                </div>


            `;

            resultsDiv.style.display = 'block';
        }

        function parseAnalysis(text) {
            const analysis = {
                hasGeoCompliance: false,
                summary: '',
                jurisdictions: [],
                laws: [],
                requirements: [],
                riskLevel: 'low',
                complianceScore: 85
            };

            // Enhanced geo-compliance detection - look for any mention of specific jurisdictions or regulations
            const geoKeywords = ['eu', 'gdpr', 'ccpa', 'california', 'us-ca', 'privacy', 'consent', 'data protection', 'european union', 'article 7', 'article 6'];
            const hasGeoKeywords = geoKeywords.some(keyword => text.toLowerCase().includes(keyword));
            
            // Check if the text mentions specific jurisdictions or regulations
            const jurisdictionMentions = text.toLowerCase().match(/(eu|european union|california|ccpa|gdpr|uk|canada|brazil)/g) || [];
            analysis.hasGeoCompliance = hasGeoKeywords || jurisdictionMentions.length > 0;

            // Enhanced summary extraction and formatting - NO TRUNCATION
            let summary = text.replace(/\n{2,}/g, '\n').trim();
            
            // Extract key compliance decision
            const complianceDecision = summary.toLowerCase().includes('does not require') ? 'No Geo-Compliance Required' :
                                     summary.toLowerCase().includes('requires') ? 'Geo-Compliance Required' :
                                     summary.toLowerCase().includes('needs') ? 'Geo-Compliance Required' :
                                     summary.toLowerCase().includes('standard implementation') ? 'Standard Implementation Sufficient' :
                                     'Compliance Assessment Complete';
            
            // Use the FULL summary without any truncation
            analysis.summary = `${complianceDecision}\n\n${summary}`;
            
            // Enhanced jurisdiction extraction with better patterns
            const jurisdictionMap = {
                'eu': { code: 'EU', name: 'European Union', flag: '🇪🇺', color: '#d2691e' },
                'european union': { code: 'EU', name: 'European Union', flag: '🇪🇺', color: '#d2691e' },
                'gdpr': { code: 'EU', name: 'European Union', flag: '🇪🇺', color: '#d2691e' },
                'california': { code: 'US-CA', name: 'California', flag: '🇺🇸', color: '#cd853f' },
                'ccpa': { code: 'US-CA', name: 'California', flag: '🇺🇸', color: '#cd853f' },
                'us-ca': { code: 'US-CA', name: 'California', flag: '🇺🇸', color: '#cd853f' },
                'canada': { code: 'CA', name: 'Canada', flag: '🇨🇦', color: '#daa520' },
                'brazil': { code: 'BR', name: 'Brazil', flag: '🇧🇷', color: '#daa520' },
                'uk': { code: 'UK', name: 'United Kingdom', flag: '🇬🇧', color: '#d2691e' }
            };

            Object.keys(jurisdictionMap).forEach(key => {
                if (text.toLowerCase().includes(key)) {
                    const jurisdiction = jurisdictionMap[key];
                    if (!analysis.jurisdictions.some(j => j.code === jurisdiction.code)) {
                        analysis.jurisdictions.push(jurisdiction);
                    }
                }
            });
            
            // Also check for specific law mentions that indicate jurisdictions
            if (text.toLowerCase().includes('gdpr') || text.toLowerCase().includes('article 7') || text.toLowerCase().includes('article 6')) {
                const euJurisdiction = jurisdictionMap['eu'];
                if (!analysis.jurisdictions.some(j => j.code === euJurisdiction.code)) {
                    analysis.jurisdictions.push(euJurisdiction);
                }
            }
            if (text.toLowerCase().includes('ccpa')) {
                const caJurisdiction = jurisdictionMap['california'];
                if (!analysis.jurisdictions.some(j => j.code === caJurisdiction.code)) {
                    analysis.jurisdictions.push(caJurisdiction);
                }
            }

            // Enhanced law extraction with better formatting
            const lawRegex = /(GDPR|CCPA|COPPA|LGPD|PIPEDA)(\s+(?:Article|Section)\s*(\d+(?:\.\d+)?|\w+))?/gi;
            const lawMatches = text.matchAll(lawRegex);
            
            for (const match of lawMatches) {
                const lawName = match[1].toUpperCase();
                const article = match[3] || '';
                const fullName = getLawFullName(lawName);
                
                if (!analysis.laws.some(law => law.name === lawName && law.article === article)) {
                    analysis.laws.push({
                        name: lawName,
                        fullName: fullName,
                        article: article,
                        description: generateLawDescription(lawName, article),
                        color: getLawColor(lawName),
                        icon: getLawIcon(lawName),
                        jurisdiction: lawName === 'GDPR' ? 'EU' : lawName === 'CCPA' ? 'US-CA' : 'Unknown'
                    });
                }
            }
            
            // Also extract laws mentioned in the original context if available
            if (window.currentRawResponse && window.currentRawResponse.includes('GDPR Article 7')) {
                if (!analysis.laws.some(law => law.name === 'GDPR' && law.article === '7')) {
                    analysis.laws.push({
                        name: 'GDPR',
                        fullName: 'General Data Protection Regulation',
                        article: '7',
                        description: 'Valid consent for data processing',
                        color: '#d2691e',
                        icon: '🇪🇺',
                        jurisdiction: 'EU'
                    });
                }
            }
            if (window.currentRawResponse && window.currentRawResponse.includes('GDPR Article 6')) {
                if (!analysis.laws.some(law => law.name === 'GDPR' && law.article === '6')) {
                    analysis.laws.push({
                        name: 'GDPR',
                        fullName: 'General Data Protection Regulation',
                        article: '6',
                        description: 'Lawful basis for processing personal data',
                        color: '#d2691e',
                        icon: '🇪🇺',
                        jurisdiction: 'EU'
                    });
                }
            }

            // Enhanced requirement extraction
            const reqPatterns = [
                /(?:must|need to|should|require[sd]?)\s+([^.!?]+)/gi,
                /(?:provide|implement|enable|ensure)\s+([^.!?]+)/gi
            ];

            reqPatterns.forEach(pattern => {
                const matches = text.matchAll(pattern);
                for (const match of matches) {
                    let requirement = match[1].trim();
                    requirement = requirement.charAt(0).toLowerCase() + requirement.slice(1);
                    if (requirement.length > 15 && requirement.length < 150 && 
                        !analysis.requirements.includes(requirement)) {
                        analysis.requirements.push(requirement);
                    }
                }
            });

            // Calculate risk level and compliance score
            analysis.riskLevel = calculateRiskLevel(analysis);
            analysis.complianceScore = calculateComplianceScore(analysis);

            return analysis;
        }

        function getLawFullName(lawCode) {
            const lawNames = {
                'GDPR': 'General Data Protection Regulation',
                'CCPA': 'California Consumer Privacy Act',
                'COPPA': 'Children\'s Online Privacy Protection Act',
                'LGPD': 'Lei Geral de Proteção de Dados',
                'PIPEDA': 'Personal Information Protection and Electronic Documents Act'
            };
            return lawNames[lawCode] || lawCode;
        }

        function getLawColor(lawCode) {
            const colors = {
                'GDPR': '#d2691e',
                'CCPA': '#cd853f',
                'COPPA': '#daa520',
                'LGPD': '#f57c00',
                'PIPEDA': '#daa520'
            };
            return colors[lawCode] || '#d2691e';
        }

        function getLawIcon(lawCode) {
            const icons = {
                'GDPR': '🇪🇺',
                'CCPA': '🇺🇸',
                'COPPA': '👶',
                'LGPD': '🇧🇷',
                'PIPEDA': '🇨🇦'
            };
            return icons[lawCode] || '⚖️';
        }

        function generateLawDescription(lawCode, article) {
            const descriptions = {
                'GDPR': article ? `GDPR Article ${article} compliance requirement` : 'General EU data protection requirement',
                'CCPA': article ? `CCPA Section ${article} compliance requirement` : 'California privacy rights requirement',
                'COPPA': 'Children\'s privacy protection requirement',
                'LGPD': 'Brazilian data protection requirement',
                'PIPEDA': 'Canadian privacy law requirement'
            };
            return descriptions[lawCode] || `${lawCode} compliance requirement`;
        }

        function calculateRiskLevel(analysis) {
            if (analysis.laws.length >= 3) return 'high';
            if (analysis.laws.length >= 2 || analysis.jurisdictions.length >= 2) return 'medium';
            if (analysis.hasGeoCompliance) return 'medium';
            return 'low';
        }

        function calculateComplianceScore(analysis) {
            let score = 100;
            score -= analysis.laws.length * 10;
            score -= analysis.jurisdictions.length * 5;
            score -= analysis.requirements.length * 3;
            return Math.max(score, 20);
        }

        function showError(message) {
            document.getElementById('results').innerHTML = `
                <div class="error">
                    <strong>Error:</strong> ${message}
                </div>
            `;
            document.getElementById('results').style.display = 'block';
        }

        // Load GDPR preset by default
        loadPreset('gdpr');

        function toggleChat() {
            const chatInterface = document.getElementById('chatInterface');
            if (chatInterface.style.display === 'none') {
                chatInterface.style.display = 'block';
                // Check if API key is already set
                const savedKey = localStorage.getItem('openaiApiKey');
                if (savedKey) {
                    openaiApiKey = savedKey;
                    document.getElementById('openaiApiKey').value = '••••••••••••••••';
                    document.getElementById('apiKeySection').style.display = 'none';
                }
            } else {
                chatInterface.style.display = 'none';
            }
        }

        function setApiKey() {
            const apiKeyInput = document.getElementById('openaiApiKey');
            const key = apiKeyInput.value.trim();
            
            if (key && key.startsWith('sk-')) {
                openaiApiKey = key;
                localStorage.setItem('openaiApiKey', key);
                apiKeyInput.value = '••••••••••••••••';
                document.getElementById('apiKeySection').style.display = 'none';
                addChatMessage('🤖 AI Assistant', 'API key set successfully! You can now chat about your compliance analysis.', 'assistant');
            } else {
                alert('Please enter a valid OpenAI API key (starts with sk-)');
            }
        }

        function updateChatContext() {
            if (window.currentAnalysis) {
                chatContext = `
Current Compliance Analysis:
- Feature: ${window.currentAnalysis.featureName || 'Not specified'}
- Summary: ${window.currentAnalysis.summary || 'Not available'}
- Jurisdictions: ${window.currentAnalysis.jurisdictions?.join(', ') || 'None detected'}
- Laws: ${window.currentAnalysis.laws?.map(law => law.name).join(', ') || 'None detected'}
- Action Items: ${window.currentAnalysis.actionItems?.length || 0} items identified
- Risk Level: ${window.currentAnalysis.riskLevel || 'Not assessed'}
- Compliance Score: ${window.currentAnalysis.complianceScore || 'Not calculated'}
                `.trim();
            } else {
                chatContext = 'No compliance analysis available yet. Please run an analysis first.';
            }
        }

        function addChatMessage(sender, message, type = 'user') {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                margin-bottom: 15px;
                padding: 12px 16px;
                border-radius: 8px;
                max-width: 80%;
                word-wrap: break-word;
                ${type === 'user' ? 
                    'background: #d2691e; color: white; margin-left: auto;' : 
                    'background: white; color: #333; border: 1px solid #e8d5c4;'
                }
            `;
            
            const senderDiv = document.createElement('div');
            senderDiv.style.cssText = `
                font-weight: bold;
                margin-bottom: 5px;
                font-size: 0.9em;
                ${type === 'user' ? 'color: rgba(255, 255, 255, 0.9);' : 'color: #d2691e;'}
            `;
            senderDiv.textContent = sender;
            
            const messageDiv2 = document.createElement('div');
            messageDiv2.textContent = message;
            
            messageDiv.appendChild(senderDiv);
            messageDiv.appendChild(messageDiv2);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (!message) return;
            
            if (!openaiApiKey) {
                alert('Please set your OpenAI API key first');
                return;
            }
            
            // Add user message
            addChatMessage('👤 You', message, 'user');
            chatInput.value = '';
            
            // Show typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.style.cssText = `
                margin-bottom: 15px;
                padding: 12px 16px;
                border-radius: 8px;
                background: white;
                color: #666;
                border: 1px solid #e8d5c4;
                font-style: italic;
            `;
            typingDiv.textContent = '🤖 AI is thinking...';
            document.getElementById('chatMessages').appendChild(typingDiv);
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openaiApiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: `You are an expert compliance analyst assistant. You help users understand compliance analysis results and provide guidance on implementation. Use the following context to answer questions:

${chatContext}

Be professional, helpful, and provide specific, actionable advice. If the user asks about compliance requirements, implementation details, or legal implications, use the analysis data to provide informed responses.`
                            },
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        max_tokens: 500,
                        temperature: 0.7
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById('typingIndicator').remove();
                
                if (data.choices && data.choices[0]) {
                    const aiResponse = data.choices[0].message.content;
                    addChatMessage('🤖 AI Assistant', aiResponse, 'assistant');
                } else {
                    addChatMessage('🤖 AI Assistant', 'Sorry, I encountered an error. Please try again.', 'assistant');
                }
                
            } catch (error) {
                // Remove typing indicator
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) typingIndicator.remove();
                
                addChatMessage('🤖 AI Assistant', 'Sorry, I encountered an error. Please check your API key and try again.', 'assistant');
                console.error('Chat error:', error);
            }
        }

        // Allow Enter key to send messages
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
        });

        function convertComplianceToAnalysis(compliance, rawResponse) {
            console.log('convertComplianceToAnalysis called with:', { compliance, rawResponse });
            console.log('compliance.need_geo_logic:', compliance.need_geo_logic);
            
            const analysis = {
                hasGeoCompliance: compliance.need_geo_logic || false,
                summary: generateSummaryFromCompliance(compliance, rawResponse),
                jurisdictions: convertJurisdictions(compliance.jurisdictions || []),
                laws: convertLegalCitations(compliance.legal_citations || []),
                requirements: generateRequirements(compliance),
                riskLevel: calculateRiskLevel(compliance),
                complianceScore: Math.round((compliance.confidence || 0.5) * 100)
            };
            
            console.log('Final analysis:', analysis);
            return analysis;
        }

        function generateSummaryFromCompliance(compliance, rawResponse) {
            // Debug logging
            console.log('generateSummaryFromCompliance called with:', { compliance, rawResponse });
            
            // Use the raw response if available, otherwise fall back to structured data
            if (rawResponse && rawResponse.trim()) {
                console.log('Using raw response:', rawResponse);
                return rawResponse;
            }
            
            const jurisdictions = compliance.jurisdictions || [];
            const dataCategories = compliance.data_categories || [];
            const lawfulBasis = compliance.lawful_basis || [];
            const consentRequired = compliance.consent_required || false;
            
            let summary = '';
            
            if (compliance.need_geo_logic) {
                summary += 'GEO-SPECIFIC COMPLIANCE REQUIRED\n\n';
                
                if (jurisdictions.length > 0) {
                    summary += `This feature requires geo-specific compliance logic for the following jurisdictions: ${jurisdictions.join(', ')}.\n\n`;
                }
                
                if (dataCategories.length > 0) {
                    summary += `Data Categories: ${dataCategories.join(', ')}\n`;
                }
                
                if (lawfulBasis.length > 0) {
                    summary += `Lawful Basis: ${lawfulBasis.join(', ')}\n`;
                }
                
                if (consentRequired) {
                    summary += 'User consent is required for data processing.\n';
                }
                
                summary += '\nImplementation should include jurisdiction-specific logic to ensure compliance with applicable regulations.';
            } else {
                summary += 'STANDARD IMPLEMENTATION SUFFICIENT\n\n';
                summary += 'This feature does not require geo-specific compliance logic. Standard implementation practices are sufficient.';
            }
            
            return summary;
        }

        function convertJurisdictions(jurisdictions) {
            const jurisdictionMap = {
                'EU': { code: 'EU', name: 'European Union', flag: '🇪🇺', color: '#d2691e' },
                'US-CA': { code: 'US-CA', name: 'California', flag: '🇺🇸', color: '#cd853f' },
                'US': { code: 'US', name: 'United States', flag: '🇺🇸', color: '#cd853f' },
                'UK': { code: 'UK', name: 'United Kingdom', flag: '🇬🇧', color: '#d2691e' },
                'Canada': { code: 'CA', name: 'Canada', flag: '🇨🇦', color: '#daa520' },
                'Brazil': { code: 'BR', name: 'Brazil', flag: '🇧🇷', color: '#daa520' }
            };
            
            return jurisdictions.map(jurisdiction => jurisdictionMap[jurisdiction] || {
                code: jurisdiction,
                name: jurisdiction,
                flag: '🌍',
                color: '#7f8c8d'
            });
        }

        function convertLegalCitations(legalCitations) {
            return legalCitations.map(citation => {
                const lawName = citation.law || citation;
                const jurisdiction = citation.jurisdiction || 'Unknown';
                
                return {
                    name: lawName.split(' ')[0],
                    fullName: getLawFullName(lawName.split(' ')[0]),
                    article: lawName.includes('Article') ? lawName.match(/Article\s+(\d+)/)?.[1] : '',
                    description: generateLawDescription(lawName.split(' ')[0], lawName.match(/Article\s+(\d+)/)?.[1] || ''),
                    color: getLawColor(lawName.split(' ')[0]),
                    icon: getLawIcon(lawName.split(' ')[0]),
                    jurisdiction: jurisdiction
                };
            });
        }

        function generateRequirements(compliance) {
            const requirements = [];
            
            if (compliance.need_geo_logic) {
                requirements.push({
                    title: 'Implement Geo-Detection Logic',
                    description: 'Add jurisdiction detection based on user location or IP address',
                    priority: 'Critical',
                    effort: '2-3 sprints'
                });
                
                if (compliance.consent_required) {
                    requirements.push({
                        title: 'Implement Consent Management',
                        description: 'Add consent collection and management system',
                        priority: 'High',
                        effort: '1-2 sprints'
                    });
                }
                
                if (compliance.jurisdictions && compliance.jurisdictions.length > 0) {
                    requirements.push({
                        title: 'Jurisdiction-Specific Features',
                        description: `Implement features specific to: ${compliance.jurisdictions.join(', ')}`,
                        priority: 'High',
                        effort: '1-2 sprints'
                    });
                }
                
                if (compliance.data_categories && compliance.data_categories.length > 0) {
                    requirements.push({
                        title: 'Data Category Handling',
                        description: `Implement proper handling for: ${compliance.data_categories.join(', ')}`,
                        priority: 'Medium',
                        effort: '1 sprint'
                    });
                }
            }
            
            return requirements;
        }

        function calculateRiskLevel(compliance) {
            if (!compliance.need_geo_logic) return 'low';
            
            let riskScore = 0;
            if (compliance.jurisdictions && compliance.jurisdictions.length > 0) riskScore += 2;
            if (compliance.consent_required) riskScore += 2;
            if (compliance.data_categories && compliance.data_categories.length > 0) riskScore += 1;
            if (compliance.legal_citations && compliance.legal_citations.length > 0) riskScore += 1;
            
            if (riskScore >= 5) return 'high';
            if (riskScore >= 3) return 'medium';
            return 'low';
        }
    </script>
</body>
</html>
